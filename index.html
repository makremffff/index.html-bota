<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SHIB Ads WebApp</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap'); 

        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Vazirmatn', Arial, Helvetica, sans-serif;overflow:hidden;background: #0d0c1d;}
        
        .app-screen {
            position: fixed;
            inset: 0;
            background: url('img.png') no-repeat center center;
            background-size: cover;
            transition: opacity .5s ease-in;
            display: flex;
            flex-direction: column;
            opacity: 0;
            pointer-events: none; 
            z-index: 10; 
        }
        .app-screen.visible {
            opacity: 1;
            pointer-events: auto;
            z-index: 20; 
        }

        /* Loading Screen - Minimalistic Spinning Circle */
        .loading-screen{
            position:fixed;inset:0;
            background: #0d0c1d;
            display:flex;flex-direction:column;justify-content:center;align-items:center;
            z-index:9999;transition:opacity .5s ease-out;
        }
        .loading-screen.hidden{opacity:0;pointer-events:none}
        
        .spinner-circle {
            width: 80px;
            height: 80px;
            border: 8px solid rgba(255, 255, 255, 0.1);
            border-top: 8px solid #00ffff; /* Neon color */
            border-radius: 50%;
            animation: spin 1.2s cubic-bezier(0.5, 0, 0.5, 1) infinite;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.6); /* Neon glow */
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* End of Loading Screen */

        /* Main Screen */
        .main-screen{
            background-color: #f0f0f0; 
        }
        
        .main-content{flex:1;display:flex;justify-content:center;align-items:center}
        
        /* User Circle */
        .user-circle{
            position:absolute;top:20px;left:20px;width:70px;height:70px;border:2px dashed #ccc;
            border-radius:50%;display:flex;flex-direction:column;justify-content:center;
            align-items:center;cursor:pointer;transition:all .3s ease;z-index:100;overflow:hidden
        }
        .user-circle:hover{border-color:#4a90e2;background:rgba(74,144,226,.05)}
        .user-circle img{width:100%;height:100%;object-fit:cover;border-radius:50%;display:none}
        .user-circle .placeholder{color:#999;font-size:12px;text-align:center}
        
        .user-username{
            position: absolute;
            top: 95px;
            left: 20px;
            width: 70px;
            font-size:13px;color:#555;white-space:nowrap;
            text-align: center;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .user-id{
            position: absolute;
            top: 115px;
            left: 20px;
            width: 70px;
            font-size:11px;color:#888;white-space:nowrap;
            text-align: center;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .balance{position:absolute;top:20px;right:20px;background:#fff;border:1px solid #ff5a5a;border-radius:12px;padding:8px 12px;font-family:'Courier New',monospace;font-size:16px;color:#ff2a2a;text-shadow:0 0 2px #ffbbbb;letter-spacing:1px;z-index:101;box-shadow:0 4px 6px rgba(0,0,0,.05)}
        
        /* Shared Progress Containers */
        .progress-group-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            flex-direction: column;
            gap: 20px;
            width: 90%;
            max-width: 300px;
            z-index: 102;
        }
        .daily-progress-container, .spin-progress-container {
            background: #fff;
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,.1);
            text-align: center;
            border-left: 5px solid #4a90e2; 
        }
        .spin-progress-container {
            border-left: 5px solid #ff8c00; 
        }
        .daily-progress-text, .spin-progress-text {font-size:14px;color:#333;margin-bottom:4px; font-weight: bold;}
        .daily-progress-bar, .spin-progress-bar {width:100%;height:12px;background:rgba(0,0,0,.1);border-radius:10px;overflow:hidden;margin-top:6px}
        .daily-progress-fill {height:100%;background:linear-gradient(90deg,#00f2fe,#4facfe);border-radius:10px;width:0%;transition:width .4s ease}
        .spin-progress-fill {height:100%;background:linear-gradient(90deg,#ff8c00, #ff4500);border-radius:10px;width:0%;transition:width .4s ease}

        /* Button Adjustments - Equal width for 5 buttons */
        .button-container{
            position:absolute;bottom:40px;left:50%;transform:translateX(-50%);
            display:grid; /* Change to grid for better control */
            grid-template-columns: repeat(5, 1fr); /* 5 equal columns (UPDATED) */
            gap: 8px; /* Slightly reduced gap */
            background:rgba(240,240,240,.9);padding:10px 10px; /* Reduced padding */
            border-radius:20px;box-shadow:0 4px 15px rgba(0,0,0,.1);backdrop-filter:blur(10px);
            width: 95%; /* Increased width for more space */
            max-width: 450px;
        }
        .nav-button{
            position:relative;background:linear-gradient(145deg,#4a90e2,#357abd);color:#fff;border:none;padding:10px 0; /* Adjust padding for height control */
            border-radius:10px;font-size:11px; /* Reduced font size for better fit */
            font-weight:bold;cursor:pointer;transition:all .1s ease;
            flex-grow: 1;
            min-width: auto;
            text-transform:uppercase;letter-spacing:.5px;box-shadow:0 5px 0 #2c5aa0,0 8px 12px rgba(0,0,0,.15);transform:translateY(0);
            text-align: center;
            line-height: 1; /* Ensure text fits */
        }
        .nav-button:hover{transform:translateY(-1px);box-shadow:0 6px 0 #2c5aa0,0 10px 15px rgba(0,0,0,.2)}
        .nav-button:active{transform:translateY(2px);box-shadow:0 3px 0 #2c5aa0,0 5px 8px rgba(0,0,0,.15)}
        .nav-button span{display:block;text-shadow:0 1px 2px rgba(0,0,0,.3)}

        .nav-button.task-btn{
            background:linear-gradient(145deg,#ffc107,#ff9800);
            box-shadow:0 5px 0 #cc9a00,0 8px 12px rgba(0,0,0,.15);
        }
        .nav-button.task-btn:hover{box-shadow:0 6px 0 #cc9a00,0 10px 15px rgba(0,0,0,.2)}
        .nav-button.task-btn:active{box-shadow:0 3px 0 #cc9a00,0 5px 8px rgba(0,0,0,.15)}

        /* NEW Style for Withdraw Nav Button */
        .nav-button.withdraw-btn-nav{
            background:linear-gradient(145deg,#ff2a2a,#cc2121);
            box-shadow:0 5px 0 #991919,0 8px 12px rgba(0,0,0,.15);
        }
        .nav-button.withdraw-btn-nav:hover{box-shadow:0 6px 0 #991919,0 10px 15px rgba(0,0,0,.2)}
        .nav-button.withdraw-btn-nav:active{box-shadow:0 3px 0 #991919,0 5px 8px rgba(0,0,0,.15)}

        /* ===== Task Screen - REDESIGNED STYLING ===== */
        .task-screen{
            display:flex;
            flex-direction:column;
            align-items:center;
            justify-content: flex-start; 
            padding-top: 50px; 
            padding-bottom: 120px; 
            overflow-y: auto;
            background: #ffffed; /* Light, paper-like background */
        }
        .task-header{ 
            text-align: center;
            margin-bottom: 30px;
            width: 90%;
            max-width: 350px;
        }
        .task-title{ 
             font-family: 'Vazirmatn', sans-serif; 
             font-size:24px; 
             color:#333; /* Dark pencil color */
             font-weight:700; 
             text-shadow: 1px 1px 0 #fff; 
             border-bottom: 2px dashed #a0a0a0;
             padding-bottom: 10px;
        }
        
        /* New Task Card Style based on user's input (Paper Style) */
        .task-content-container {
            width: 100%;
            padding: 0 10px;
            max-width: 400px;
        }

        .task-item-card {
            background:#ffffff; /* White card */
            margin:10px 0;
            padding:18px;
            border-radius:10px;
            display:flex;
            justify-content:space-between;
            align-items:center;
            border: 1px solid #ddd; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        .task-text-info {
            color: #555; /* Slightly lighter text */
            font-size: 16px;
            font-weight: 500;
        }

        /* Button style from user's input (Pencil Style Action Button) */
        .task-action-btn-new {
            background:linear-gradient(145deg, #ffc107, #ff9800);
            border:1px solid #cc9a00;
            color:#fff;
            padding:10px 20px;
            border-radius:8px;
            cursor:pointer;
            font-size:1em;
            font-weight: bold;
            min-width: 90px; 
            transition: all 0.1s ease;
            box-shadow: 0 4px 0 #cc9a00;
            text-transform: uppercase;
        }
        .task-action-btn-new:hover {
            transform: translateY(-1px);
            box-shadow: 0 5px 0 #cc9a00;
        }
        .task-action-btn-new:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 #cc9a00;
        }
        .task-action-btn-new:disabled {
            background:#ccc;
            border-color:#aaa;
            color:#666;
            cursor:not-allowed;
            box-shadow: 0 4px 0 #aaa;
            transform: translateY(0);
        }
        
        .task-action-btn-new.completed {
            background:linear-gradient(145deg, #28a745, #1e7e34); /* Green for completed */
            border-color: #1c6d32;
            color: #fff;
            cursor: default;
            box-shadow: 0 4px 0 #1c6d32;
        }
        .task-action-btn-new.completed:disabled {
             background:linear-gradient(145deg, #1e7e34, #1c6d32); /* Darker green when disabled (after completion) */
             color: #ccc;
             box-shadow: 0 4px 0 #1c6d32;
        }
        
        /* Task Note style - REMOVED */
        .task-screen .note{ display: none; }

        /* Back Button Style - FIXED at bottom */
        .task-back-btn {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background:linear-gradient(145deg, #6c757d, #5a6268);
            color:#fff;border:none;padding:15px 40px; /* Larger padding */
            border-radius:12px;
            font-size:16px;
            font-weight:bold;
            cursor:pointer;
            box-shadow:0 6px 0 #4e555b; /* Larger shadow */
            transition:all .1s ease;
            width: 90%;
            max-width: 350px;
            z-index: 1000; /* Ensure it's above other elements */
        }
        .task-back-btn:active{transform:translateY(3px) translateX(-50%);box-shadow:0 3px 0 #4e555b}
        
        /* ===== Spin Screen ===== */
        .spin-screen{
            display:flex;flex-direction:column;align-items:center;justify-content:center;
            transition:opacity .3s ease;
        }
        #wheelBox{position:relative;margin-bottom:25px}
        #wheelCanvas{
            border-radius:50%;
            /* Enhanced 3D Look */
            box-shadow:0 0 0 10px #eee, 0 15px 35px rgba(0,0,0,0.4); 
            background-color: #fefefe; 
            border: 2px solid #ccc; 
        }
        .arrow{
            position:absolute;top:-16px;left:50%;transform:translateX(-50%);
            width:0;height:0;border-left:18px solid transparent;border-right:18px solid transparent;
            border-top:28px solid #ff3366;filter:drop-shadow(0 3px 2px rgba(0,0,0,.3));z-index:10;
        }
        .spin-btn{background:#ff3366;color:#fff;border:none;padding:12px 35px;border-radius:30px;font-size:16px;font-weight:bold;cursor:pointer;box-shadow:0 6px 0 #cc2950;transition:all .1s ease}
        .spin-btn:active{transform:translateY(3px);box-shadow:0 3px 0 #cc2950}
        .spin-result{margin-top:18px;font-size:18px;color:#333}
        .spin-back{margin-top:25px;background:#6c757d;color:#fff;border:none;padding:10px 25px;border-radius:8px;font-size:15px;font-weight:bold;cursor:pointer;box-shadow:0 4px 0 #5a6268}
        .spin-back:active{transform:translateY(2px);box-shadow:0 2px 0 #5a6268}

        /* ===== Withdraw Screen - (No changes needed) ===== */
        .withdraw-screen{
            display:flex;flex-direction:column;align-items:center;padding:20px 20px;
            transition:opacity .3s ease;
            overflow-y: auto;
        }
        .withdraw-header{
            text-align: center;
            margin-bottom: 25px;
            width: 100%;
            max-width: 400px;
            background: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 15px;
        }
        .withdraw-title{
            font-size:28px;color:#ff2a2a;font-weight:700; text-shadow: 0 1px 1px rgba(0,0,0,.1);
        }
        .current-balance-info{
            font-size: 16px;
            color: #555;
            margin-top: 10px;
            font-weight: bold;
        }
        .input-form-container {
            width: 100%;
            max-width: 400px;
            background: #fff;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 6px 20px rgba(0,0,0,.1);
            border: 1px solid #ddd;
            margin-bottom: 20px;
        }
        .input-group{
            width:100%;margin-bottom:15px;
        }
        .input-group label{display:block;margin-bottom:8px;font-size:14px;color:#555;font-weight:600;}
        .input-group input{width:100%;padding:12px 15px;border:1px solid #ddd;border-radius:10px;font-size:16px;transition:border-color .3s ease, box-shadow .3s ease;outline:none;}
        .input-group input:focus{border-color:#ff8c00;box-shadow:0 0 0 3px rgba(255,140,0,0.2);}
        .withdraw-buttons{display:flex;gap:15px;margin-top:20px;justify-content: center;}
        .withdraw-btn{
            background:linear-gradient(145deg, #28a745, #1e7e34);
            color:#fff;border:none;padding:12px 30px;border-radius:10px;font-size:16px;font-weight:bold;cursor:pointer;
            box-shadow:0 5px 0 #1c6d32;transition:all .1s ease;
            width: 100%;
        }
        .withdraw-btn:active{transform:translateY(3px);box-shadow:0 2px 0 #1c6d32}
        .back-btn{
            background:linear-gradient(145deg, #6c757d, #5a6268);
            color:#fff;border:none;padding:12px 30px;border-radius:10px;font-size:16px;font-weight:bold;cursor:pointer;
            box-shadow:0 5px 0 #4e555b;transition:all .1s ease;
        }
        .back-btn:active{transform:translateY(3px);box-shadow:0 2px 0 #4e555b}
        .note{margin-top:15px;font-size:13px;color:#777;max-width:400px;text-align:center;background:rgba(255,140,0,0.1);padding:10px;border-radius:10px;border-left: 5px solid #ff8c00;}

        /* Withdrawal History Table */
        .history-section{
            width: 100%;
            max-width: 400px;
            margin-top: 30px;
            padding: 20px 0;
            border-top: 1px solid #eee;
            background: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 15px;
        }
        .history-title{
            font-size: 20px;
            color: #333;
            margin-bottom: 15px;
            font-weight: 700;
            text-align: center;
        }
        .history-table{
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        .history-table th, .history-table td{
            padding: 10px;
            border-bottom: 1px solid #eee;
            text-align: left;
        }
        .history-table th{
            background-color: #f0f4f8;
            color: #4a90e2;
            font-weight: 700;
        }
        .history-table tr:last-child td{
            border-bottom: none;
        }
        .status-pending{color: #ff8c00; font-weight: bold;}
        .status-completed{color: #28a745; font-weight: bold;}
        .no-records{text-align: center; color: #999; padding: 20px;}
        
        /* ===== Invite Screen - (No changes needed) ===== */
        .invite-screen{
            display:flex;flex-direction:column;align-items:center;padding:20px 20px;
            transition:opacity .3s ease;
            overflow-y: auto;
        }
        .invite-header{ 
            text-align: center;
            margin-bottom: 25px;
            width: 100%;
            max-width: 400px;
            background: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 15px;
        }
        .invite-title{
            font-size:28px;color:#4a90e2;font-weight:700; text-shadow: 0 1px 1px rgba(0,0,0,.1);
        }
        .referrals-count-info{
            font-size: 18px;
            color: #333;
            margin-top: 15px;
            font-weight: bold;
            padding: 10px 15px;
            background: #e6f0ff;
            border-radius: 10px;
            border: 1px solid #cce0ff;
            box-shadow: 0 2px 5px rgba(0,0,0,.05);
            width: 100%;
        }
        .input-form-container-invite {
            width: 100%;
            max-width: 400px;
            background: #fff;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 6px 20px rgba(0,0,0,.1);
            border: 1px solid #ddd;
            margin-bottom: 20px;
        }
        .invite-buttons{
            width: 100%;
            margin-top: 15px;
        }
        .copy-link-btn{
            background:linear-gradient(145deg, #00bfff, #0077b3);
            color:#fff;border:none;padding:12px 30px;border-radius:10px;font-size:16px;font-weight:bold;cursor:pointer;
            box-shadow:0 5px 0 #005a8d;transition:all .1s ease;
            width: 100%;
        }
        .copy-link-btn:active{transform:translateY(3px);box-shadow:0 2px 0 #005a8d}

        /* ===== Alert Box (No changes needed) ===== */
        .custom-alert-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 99999;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        .custom-alert-overlay.visible {
            opacity: 1;
            pointer-events: auto;
        }
        .custom-alert-box {
            background: #fff;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            max-width: 80%;
            text-align: center;
            position: relative;
            transform: scale(0.9);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 5px solid #ffc107; /* Base border for the paper theme */
        }
        .custom-alert-overlay.visible .custom-alert-box {
            transform: scale(1);
        }
        .alert-icon {
            font-size: 30px;
            margin-bottom: 10px;
        }
        .alert-icon::before {
            content: 'üìå'; /* Default marker icon */
        }
        .alert-title {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 10px;
            color: #333;
        }
        .alert-message {
            font-size: 16px;
            color: #666;
            margin-bottom: 20px;
            white-space: pre-wrap; /* For multiline messages */
        }
        .alert-close-btn {
            background:linear-gradient(145deg, #a0522d, #8b4513); /* Sienna/Brown for a pencil/old paper theme */
            color:#fff;
            border:none;
            padding:10px 25px;
            border-radius: 8px;
            font-size: 15px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 0 #543b27;
            transition: all 0.1s ease;
        }
        .alert-close-btn:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 #543b27;
        }
        /* Specific styles for Success */
        .custom-alert-box.success .alert-title { color: #28a745; }
        .custom-alert-box.success .alert-icon::before { content: 'üéÆ'; }
        /* Specific styles for Error/Warning */
        .custom-alert-box.error .alert-title { color: #dc3545; }
        .custom-alert-box.error .alert-icon::before { content: 'ü§¶'; }
        /* Specific styles for Warning/Info - Using Yellow/Brown for Pencil/Paper Theme */
        .custom-alert-box.warning .alert-title { color: #8B4513; } /* Brown */
        .custom-alert-box.warning .alert-icon::before { content: '‚úçÔ∏è'; } /* Pencil/Writing Icon */
    </style>
</head>
<body>
    <div class="loading-screen" id="loadingScreen">
        <div class="spinner-circle"></div>
    </div>
    
    <div class="app-screen main-screen" id="mainScreen">
        <div class="balance" id="shibBalance">0 SHIB</div>
        
        <div class="user-circle" onclick="circleClick()">
            <img id="userImage" style="display:none;" alt="User Photo">
            <div class="placeholder">TAP</div>
        </div>
        <div class="user-username" id="userName">User</div>
        <div class="user-id" id="userId">ID: 0</div>
        
        <div class="progress-group-container">
            <div class="daily-progress-container">
                <div class="daily-progress-text">Ads today: <span id="adsCount">0</span> / 100</div>
                <div class="daily-progress-bar">
                    <div class="daily-progress-fill" id="dailyProgressFill"></div>
                </div>
            </div>
            <div class="spin-progress-container">
                <div class="spin-progress-text">Spins today: <span id="spinCount">0</span> / 15</div>
                <div class="spin-progress-bar">
                    <div class="spin-progress-fill" id="spinProgressFill"></div>
                </div>
            </div>
        </div>

        <div class="button-container">
            <button class="nav-button" onclick="watchAds()">
                <span>üì∫ Ads</span>
            </button>
            <button class="nav-button" onclick="showSpin()">
                <span>üé° Spin</span>
            </button>
            <button class="nav-button task-btn" onclick="showTask()">
                <span>üìã Task</span>
            </button>
            <button class="nav-button withdraw-btn-nav" onclick="showWithdraw()">
                <span>üí∞ Withdraw</span>
            </button>
            <button class="nav-button" onclick="showInvite()">
                <span>üë• Invite</span>
            </button>
        </div>
    </div>

    <div class="app-screen task-screen" id="taskScreen">
        <div class="task-header">
            <div class="task-title">Daily Task</div>
        </div>
        
        <div class="task-content-container" id="taskContentContainer">
            <div class="task-item-card" id="oldTaskCard">
                <div>
                    <div class="task-text-info">Join Our Telegram Channel</div>
                    <div id="taskRewardText" style="font-size:12px; color:#4a90e2; margin-top:5px; font-weight:600;">Reward: 50 SHIB</div>
                </div>
                <button class="task-action-btn-new" id="taskActionBtn" onclick="handleTaskAction()">Join</button>
            </div>
            </div>
        
        <button class="task-back-btn" onclick="hideTask()">Back to Main</button>
    </div>

    <div class="app-screen spin-screen" id="spinScreen">
        <div id="wheelBox">
            <div class="arrow"></div>
            <canvas id="wheelCanvas" width="300" height="300"></canvas>
        </div>
        <button class="spin-btn" id="spinBtn" onclick="spinWheel()">SPIN</button>
        <div class="spin-result" id="spinResult">Ready to spin!</div>
        <button class="spin-back" onclick="hideSpin()">Back</button>
    </div>

    <div class="app-screen withdraw-screen" id="withdrawScreen">
        <div class="withdraw-header">
            <div class="withdraw-title">Withdraw SHIB</div>
            <div class="current-balance-info">Your Balance: <span id="withdrawBalance">0</span> SHIB</div>
        </div>
        <div class="input-form-container">
            <div class="input-group">
                <label for="binanceIdInput">Binance Pay ID (Your ID):</label>
                <input type="text" id="binanceIdInput" placeholder="Enter your Binance Pay ID">
            </div>
            <div class="input-group">
                <label for="amountInput">Amount (Min 1,000 SHIB):</label>
                <input type="number" id="amountInput" placeholder="e.g., 1000" min="1000">
            </div>
            <div class="withdraw-buttons">
                <button class="withdraw-btn" onclick="submitWithdrawal()">Request Withdrawal</button>
            </div>
        </div>
        <div class="note">
            ‚ö†Ô∏è Please ensure the Binance Pay ID is correct. Transactions are irreversible. Processing may take up to 24 hours.
        </div>
        
        <div class="history-section">
            <div class="history-title">Withdrawal History</div>
            <table class="history-table" id="withdrawalHistoryTable">
                <thead>
                    <tr>
                        <th>Amount</th>
                        <th>Date</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    </tbody>
            </table>
        </div>
        <button class="back-btn" onclick="hideWithdraw()">Back to Main</button>
    </div>
    
    <div class="app-screen invite-screen" id="inviteScreen">
        <div class="invite-header">
            <div class="invite-title">Invite Friends</div>
            <div class="referrals-count-info">Total Referrals: <span id="referralsCount">0</span></div>
        </div>
        <div class="input-form-container-invite">
            <div class="input-group">
                <label>Your Referral Link</label>
                <input type="text" id="referralLinkInput" readonly value="Generating Link...">
            </div>
            <div class="invite-buttons">
                <button class="copy-link-btn" onclick="copyReferralLink()">Copy Link</button>
            </div>
        </div>
        <div class="note">
            üöÄ Share this link to invite new users. You will earn 5% of the revenue from every referral you bring through ads! 
        </div>
        <button class="back-btn" onclick="hideInvite()">Back to Main</button>
    </div>

    <div id="customAlert" class="custom-alert-overlay">
        <div class="custom-alert-box">
            <div class="alert-icon" id="alertIcon"></div>
            <div class="alert-title" id="alertTitle"></div>
            <div class="alert-message" id="alertMessage"></div>
            <button class="alert-close-btn" onclick="document.getElementById('customAlert').classList.remove('visible')">OK</button>
        </div>
    </div>

    <audio id="backgroundAudio" loop>
        <source src="audio.mp3" type="audio/mp3">
        Your browser does not support the audio element.
    </audio>
    <audio id="successSFX">
        <source src="success.mp3" type="audio/mp3">
    </audio>
    <audio id="errorSFX">
        <source src="error.mp3" type="audio/mp3">
    </audio>

    <script src='//libtl.com/sdk.js' data-zone='10245709' data-sdk='show_10245709'></script>
    
    <script>
        /* ===== Global Constants and State (MODIFIED) ===== */
        const API_URL = '/api';
        const DAILY_MAX = 100;
        const DAILY_MAX_SPINS = 15;
        const TASK_REWARD = 50;
        const SPIN_SECTORS_PRIZES = [5, 10, 15, 20, 5];
        let taskCompleted = false; // State from the server for the OLD task
        let isProcessingTask = false;
        let countdownInterval = null;
        let taskActionState = 'JOIN_OR_CLAIM'; // JOIN_OR_CLAIM, CLAIM, COMPLETED (for the OLD task)
        
        let state = {
            balance: 0,
            ads_watched_today: 0,
            spins_today: 0,
            referrals_count: 0,
            is_banned: false,
            withdrawal_history: [],
            newTasks: [] // ‚¨ÖÔ∏è NEW STATE FOR NEW TASKS
        };
        
        /* ===== Utility Functions (No change) ===== */
        
        function updateState(newState) {
            Object.assign(state, newState);
            updateUI();
        }

        function showCustomAlert(title, message, type = 'info') {
            // ... (Existing implementation)
        }
        
        async function fetchApi(payload) {
            // ... (Existing implementation)
            // ‚ö†Ô∏è Added support for 'completeNewTask' error message translation
            if (payload.type === 'completeNewTask' && errorMessage.includes('already completed')) {
                alertTitle = 'Task Completed!';
                alertType = 'warning';
                cleanMessage = 'Reward already claimed. Task is complete.';
            } else if (payload.type === 'completeNewTask' && errorMessage.includes('reached maximum')) {
                alertTitle = 'Task Full!';
                alertType = 'warning';
                cleanMessage = 'Task capacity reached. The task is no longer available.';
            } 
            // ... (Rest of existing implementation)
        }
        
        async function requestActionId(actionType) {
            // ... (Existing implementation)
        }

        /* ===== UI and Data Handlers (MODIFIED) ===== */

        function updateUI() {
            // ... (Existing balance, progress, spin UI updates)
            
            // --- Task Screen UI (FOR OLD TASK) ---
            const taskBtn = document.getElementById('taskActionBtn');
            const taskRewardText = document.getElementById('taskRewardText');
            
            if (taskBtn) {
                if (isProcessingTask) {
                    // Countdown is running, text is handled in claimTaskReward
                    taskBtn.disabled = true;
                } else if (taskActionState === 'COMPLETED') {
                    taskBtn.textContent = 'Completed';
                    taskBtn.disabled = true;
                    taskBtn.classList.remove('task-action-btn-new');
                    taskBtn.classList.add('completed');
                } else if (taskActionState === 'CLAIM') {
                    taskBtn.textContent = 'Claim';
                    taskBtn.disabled = false;
                    taskBtn.classList.remove('completed');
                    taskBtn.classList.add('task-action-btn-new');
                } else { // JOIN_OR_CLAIM
                    taskBtn.textContent = 'Join';
                    taskBtn.disabled = false;
                    taskBtn.classList.remove('completed');
                    taskBtn.classList.add('task-action-btn-new');
                }
            }
            if (taskRewardText) {
                 taskRewardText.textContent = `Reward: ${TASK_REWARD} SHIB`;
            }

            // ‚¨ÖÔ∏è NEW: Render the new tasks if the task screen is visible
            if (document.getElementById('taskScreen').classList.contains('visible')) {
                renderNewTasks();
            }
        }
        
        async function loadUserData() {
            // ... (Existing implementation)
            // ‚¨ÖÔ∏è Keep only the essential data for the main screen. New task data will be loaded separately.
            if (result.ok) {
                if (result.data.is_banned) {
                    // ... (Existing ban handling)
                }
                updateState({
                    balance: result.data.balance,
                    ads_watched_today: result.data.ads_watched_today,
                    spins_today: result.data.spins_today,
                    referrals_count: result.data.referrals_count,
                    is_banned: false,
                    task_completed: result.data.task_completed || false,
                    withdrawal_history: (result.data.withdrawal_history || []).map(item => ({ 
                        amount: item.amount, 
                        status: item.status, 
                        date: new Date(item.created_at).toLocaleDateString('en-GB') 
                    })),
                    // newTasks is NOT loaded here
                });
                // ... (Existing state update for old task)
                mainScreen.classList.add('visible');
            }
        }
        
        // ... (Existing initDailyProgress, drawWheel, spinWheel, watchAds, circleClick)

        /* ===== Task Screen Functions (MODIFIED) ===== */

        async function loadNewTasks() {
            if (!tgUser) return;
            const container = document.getElementById('taskContentContainer');
            // Check if the old card is present before clearing.
            const oldTaskCard = document.getElementById('oldTaskCard');
            const oldCardHTML = oldTaskCard ? oldTaskCard.outerHTML : '';
            
            // Temporary placeholder for loading
            container.innerHTML = oldCardHTML + '<div id="newTasksPlaceholder" style="text-align:center; padding: 20px; color:#555;">Loading new tasks...</div>';
            
            const result = await fetchApi({
                type: 'getNewTasks', // ‚¨ÖÔ∏è NEW API TYPE
            });

            if (result.ok) {
                updateState({ newTasks: result.data.tasks });
            } else {
                 document.getElementById('newTasksPlaceholder').innerHTML = '<div style="text-align:center; padding: 20px; color:#dc3545; font-weight:bold;">Failed to load tasks.</div>';
            }
        }

        function renderNewTasks() {
            const container = document.getElementById('taskContentContainer');
            const oldTaskCard = document.getElementById('oldTaskCard');
            const oldCardHTML = oldTaskCard ? oldTaskCard.outerHTML : '';
            
            // Clear and re-insert the old card
            container.innerHTML = oldCardHTML; 

            if (state.newTasks.length === 0) {
                container.innerHTML += '<div style="text-align:center; padding: 20px; color:#999;">No new tasks available. Check back later.</div>';
                return;
            }

            state.newTasks.forEach(task => {
                const isCompleted = task.is_completed;
                const buttonText = isCompleted ? 'Completed' : 'Go to Task';
                const buttonClass = isCompleted ? 'task-action-btn-new completed' : 'task-action-btn-new';
                const isDisabled = isCompleted ? 'disabled' : '';
                
                // Use task_reward.toLocaleString() to ensure formatting
                const reward = task.task_reward ? parseFloat(task.task_reward).toLocaleString() : '0';

                const taskHtml = `
                    <div class="task-item-card" data-task-id="${task.id}">
                        <div>
                            <div class="task-text-info">${task.task_name}</div>
                            <div style="font-size:12px; color:#4a90e2; margin-top:5px; font-weight:600;">Reward: ${reward} SHIB</div>
                            <div style="font-size:10px; color:#888; margin-top:2px;">Users: ${task.current_users.toLocaleString()} / ${task.max_users.toLocaleString()}</div>
                        </div>
                        <button 
                            class="${buttonClass}" 
                            ${isDisabled}
                            onclick="handleNewTaskClick(${task.id}, '${task.task_url}', ${isCompleted}, this)"
                            data-task-url="${task.task_url}"
                        >
                            ${buttonText}
                        </button>
                    </div>
                `;
                container.innerHTML += taskHtml;
            });
        }
        
        async function handleNewTaskClick(taskId, taskUrl, isCompleted, buttonElement) {
            if (isCompleted) {
                showCustomAlert('Task Completed!', 'Reward already claimed. This task is complete.', 'warning');
                return;
            }

            // 1. Redirect to URL (Go to Task)
            if (buttonElement.textContent === 'Go to Task') {
                buttonElement.disabled = true;
                buttonElement.textContent = 'Redirecting...';

                // Open the link
                if (typeof Telegram.WebApp.openTelegramLink === 'function') {
                    Telegram.WebApp.openTelegramLink(taskUrl);
                } else {
                    window.open(taskUrl, '_blank');
                }

                // After opening, change button to 'Claim' and prompt user
                setTimeout(() => {
                    buttonElement.disabled = false;
                    buttonElement.textContent = 'Claim Reward';
                    showCustomAlert('Action Required', 'Please complete the task and click "Claim Reward" to get your SHIB.', 'warning');
                }, 1000); 
                
                return;
            }
            
            // 2. Claim Reward (Claim Reward)
            if (buttonElement.textContent === 'Claim Reward') {
                const originalText = buttonElement.textContent;
                buttonElement.disabled = true;
                
                // a. Request Action ID
                const actionId = await requestActionId('completeNewTask'); // ‚¨ÖÔ∏è New action type
                if (!actionId) {
                    buttonElement.disabled = false;
                    buttonElement.textContent = originalText;
                    return;
                }

                // b. Send Completion Request
                buttonElement.textContent = 'Claiming...';
                const result = await fetchApi({
                    type: 'completeNewTask', // ‚¨ÖÔ∏è NEW API TYPE
                    task_id: taskId,
                    action_id: actionId,
                });

                if (result.ok) {
                    // Success: Update UI and state
                    updateState({ balance: result.data.new_balance });
                    
                    buttonElement.textContent = 'Completed';
                    buttonElement.classList.remove('task-action-btn-new');
                    buttonElement.classList.add('completed');
                    buttonElement.disabled = true;
                    
                    // Update local state for this task
                    state.newTasks = state.newTasks.map(t => 
                        t.id === taskId ? { 
                            ...t, 
                            is_completed: true, 
                            current_users: result.data.new_current_users 
                        } : t
                    );
                    renderNewTasks(); // Re-render to update the user count display

                    showCustomAlert('Success!', `You earned ${result.data.actual_reward} SHIB!`, 'success');
                } else {
                    // Error: Check for specific messages
                    let errorMessage = 'Failed to claim reward. Please ensure you completed the task.';
                    if (result.error && result.error.includes('already completed')) {
                        errorMessage = 'Reward already claimed. Task is complete.';
                        // Force update button and state
                        buttonElement.textContent = 'Completed';
                        buttonElement.classList.remove('task-action-btn-new');
                        buttonElement.classList.add('completed');
                        buttonElement.disabled = true;
                         // Update local state if server confirmed completion
                        state.newTasks = state.newTasks.map(t => t.id === taskId ? { ...t, is_completed: true } : t);
                        renderNewTasks();
                    } else if (result.error && result.error.includes('reached maximum')) {
                        errorMessage = 'Task capacity reached. The task is no longer available.';
                        // If task is full, disable it
                        buttonElement.textContent = 'Full';
                        buttonElement.disabled = true;
                        // Update local state if task is full
                        state.newTasks = state.newTasks.map(t => t.id === taskId ? { ...t, max_users: t.current_users } : t);
                        renderNewTasks(); 
                    } else if (result.error && result.error.includes('User not found')) {
                         errorMessage = 'User data error. Please try restarting the Mini App.';
                    } else if (result.error) {
                        errorMessage = result.error;
                    }

                    showCustomAlert('Claim Failed!', errorMessage, 'error');
                    
                    // Reset button if error was not about completion/fullness
                    if (!result.error || (!result.error.includes('already completed') && !result.error.includes('reached maximum'))) {
                         buttonElement.disabled = false;
                         buttonElement.textContent = originalText; // Keep as 'Claim Reward' for retrying
                    }
                }
            }
        }

        // ** MODIFIED: Now displays the actual task screen and loads new tasks **
        function showTask(){
            if (isBanned) {
                showCustomAlert('Access Denied!', 'This account has been banned.', 'error');
                return;
            }
            mainScreen.classList.remove('visible');
            document.getElementById('taskScreen').classList.add('visible');
            loadUserData(); // Load user data for the old task status/balance
            loadNewTasks(); // ‚¨ÖÔ∏è NEW: Load the new tasks list
        }

        function hideTask(){
            // ... (Existing implementation)
        }

        async function claimTaskReward(){
            // ... (Existing implementation for the OLD task - No change)
        }

        function handleTaskAction() {
            // ... (Existing implementation for the OLD task - No change)
        }
        
        // ... (Rest of existing JS functions: showSpin, hideSpin, showWithdraw, hideWithdraw, submitWithdrawal, displayWithdrawals, showInvite, hideInvite, copyReferralLink, Audio functions, Init and Event listeners)
        
        /* ===== Telegram User & Referral Setup (Modified to include audio) ===== */
        Telegram.WebApp.ready();
        let tgUser = null;
        if(Telegram.WebApp.initDataUnsafe && Telegram.WebApp.initDataUnsafe.user){
            tgUser = Telegram.WebApp.initDataUnsafe.user;
            const photoUrl = tgUser.photo_url;
            const userName = tgUser.first_name + (tgUser.last_name? ' '+tgUser.last_name:'');
            const userId = tgUser.id;
            const imgEl = document.getElementById('userImage');
            const nameEl = document.getElementById('userName');
            const idEl = document.getElementById('userId');
            const placeHolder = document.querySelector('.placeholder');
            if(photoUrl){
                imgEl.src = photoUrl;
                imgEl.style.display = 'block';
                placeHolder.style.display = 'none';
            }
            nameEl.textContent = userName;
            idEl.textContent = 'ID: ' + userId;
        }

        function getRefParam() {
            let referrerId = null;
            const REF_PREFIX = 'ref_';
            if (Telegram.WebApp.initDataUnsafe && Telegram.WebApp.initDataUnsafe.start_param) {
                const startParam = Telegram.WebApp.initDataUnsafe.start_param;
                if (startParam.startsWith(REF_PREFIX)) {
                    referrerId = startParam.substring(REF_PREFIX.length);
                    console.log('Referrer ID from start_param:', referrerId);
                }
            }
            return referrerId;
        }

        let referrerId = getRefParam();
        
        // ------------------------------------------------------------------
        // Fetch API Core Function
        // ------------------------------------------------------------------
        // ... (Existing fetchApi function)
        async function fetchApi(payload) {
            if (!tgUser && payload.type !== 'commission') {
                showCustomAlert('Error!', 'Telegram user data is missing. Please open the Mini App from Telegram.', 'error');
                return { ok: false, error: 'User data missing.' };
            }

            if (typeof Telegram.WebApp.showProgress === 'function') {
                Telegram.WebApp.showProgress(true);
            }
            
            const fullPayload = {
                ...payload,
                user_id: tgUser ? tgUser.id : null,
                initData: Telegram.WebApp.initData,
            };

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(fullPayload),
                });

                if (typeof Telegram.WebApp.hideProgress === 'function') {
                    Telegram.WebApp.hideProgress();
                }

                const data = await response.json();

                if (!response.ok || !data.ok) {
                    const errorMessage = data.error || `Server error (Status ${response.status})`;
                    console.error(`API Error for type ${payload.type}:`, errorMessage);

                    let cleanMessage;
                    let alertTitle;
                    let alertType;

                    // Specific error handling for Arabic and English translations
                    if (response.status === 401) {
                         alertTitle = 'Security Check Failed!';
                         alertType = 'error';
                         cleanMessage = 'Your session has expired. Please restart the Mini App.';
                    } else if (response.status === 409 || response.status === 408) {
                        alertTitle = 'Security Error!';
                        alertType = 'error';
                        cleanMessage = 'A security-related error occurred. Please try again.';
                    } else if (payload.type === 'completeTask' && errorMessage.includes('already completed')) {
                        alertTitle = 'Task Completed!';
                        alertType = 'warning';
                        cleanMessage = 'Reward already claimed. Task is complete.';
                    } else if (payload.type === 'completeTask' && errorMessage.includes('not joined')) {
                        alertTitle = 'Task Failed!';
                        alertType = 'error';
                        cleanMessage = 'Membership not verified. Please ensure you joined the channel and try again.';
                    } else if (payload.type === 'completeNewTask' && errorMessage.includes('already completed')) {
                        alertTitle = 'Task Completed!';
                        alertType = 'warning';
                        cleanMessage = 'Reward already claimed. Task is complete.';
                    } else if (payload.type === 'completeNewTask' && errorMessage.includes('reached maximum')) {
                        alertTitle = 'Task Full!';
                        alertType = 'warning';
                        cleanMessage = 'Task capacity reached. The task is no longer available.';
                    } else {
                        // General error handling (English)
                        alertTitle = 'Operation Failed!';
                        alertType = 'error';
                        cleanMessage = errorMessage;
                    }
                    showCustomAlert(alertTitle, cleanMessage, alertType);
                    return { ok: false, error: errorMessage };
                }
                return data;
            } catch (error) {
                if (typeof Telegram.WebApp.hideProgress === 'function') {
                    Telegram.WebApp.hideProgress();
                }
                console.error(`General Fetch Error for type ${payload.type}:`, error.message);
                // English translation of the Arabic alert message
                showCustomAlert('Connection Error!', 'Could not connect to the server. Please check your internet connection.', 'error');
                return { ok: false, error: error.message };
            }
        }
        
        // ------------------------------------------------------------------
        // NEW: Function to request Action ID from the Server
        // ------------------------------------------------------------------
        async function requestActionId(actionType) {
            const result = await fetchApi({
                type: 'generateActionId',
                action_type: actionType
            });
            if (result.ok) {
                return result.data.action_id;
            }
            return null;
        }

        // ------------------------------------------------------------------
        // Initialization and Event Listeners
        // ------------------------------------------------------------------

        // ... (Existing init, runRegister, initDailyProgress, etc.)

        async function init(){
            // ... (Existing code)
        }
        
        // Final event listener to ensure background audio starts on the first user interaction
        document.addEventListener('click', function handler() {
            playBGAudio();
            document.removeEventListener('click', handler); // Remove after first successful click
        });
        
        // Run Initialization
        init();
    </script>
</body>
</html>
