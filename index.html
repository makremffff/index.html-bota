<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SHIB Ads WebApp</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap'); 

        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Vazirmatn', Arial, Helvetica, sans-serif;overflow:hidden;background: #0d0c1d;}
        
        .app-screen {
            position: fixed;
            inset: 0;
            background: url('img.png') no-repeat center center;
            background-size: cover;
            transition: opacity .5s ease-in;
            display: flex;
            flex-direction: column;
            opacity: 0;
            pointer-events: none; 
            z-index: 10; 
        }
        .app-screen.visible {
            opacity: 1;
            pointer-events: auto;
            z-index: 20; 
        }

        /* Loading Screen - Minimalistic Spinning Circle */
        .loading-screen{
            position:fixed;inset:0;
            background: #0d0c1d;
            display:flex;flex-direction:column;justify-content:center;align-items:center;
            z-index:9999;transition:opacity .5s ease-out;
        }
        .loading-screen.hidden{opacity:0;pointer-events:none}
        
        .spinner-circle {
            width: 80px;
            height: 80px;
            border: 8px solid rgba(255, 255, 255, 0.1);
            border-top: 8px solid #00ffff; /* Neon color */
            border-radius: 50%;
            animation: spin 1.2s cubic-bezier(0.5, 0, 0.5, 1) infinite;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.6); /* Neon glow */
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* End of Loading Screen */

        /* Main Screen */
        .main-screen{
            background-color: #f0f0f0; 
        }
        
        .main-content{flex:1;display:flex;justify-content:center;align-items:center}
        
        /* User Circle */
        .user-circle{
            position:absolute;top:20px;left:20px;width:70px;height:70px;border:2px dashed #ccc;
            border-radius:50%;display:flex;flex-direction:column;justify-content:center;
            align-items:center;cursor:pointer;transition:all .3s ease;z-index:100;overflow:hidden
        }
        .user-circle:hover{border-color:#4a90e2;background:rgba(74,144,226,.05)}
        .user-circle img{width:100%;height:100%;object-fit:cover;border-radius:50%;display:none}
        .user-circle .placeholder{color:#999;font-size:12px;text-align:center}
        
        .user-username{
            position: absolute;
            top: 95px;
            left: 20px;
            width: 70px;
            font-size:13px;color:#555;white-space:nowrap;
            text-align: center;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .user-id{
            position: absolute;
            top: 115px;
            left: 20px;
            width: 70px;
            font-size:11px;color:#888;white-space:nowrap;
            text-align: center;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .balance{position:absolute;top:20px;right:20px;background:#fff;border:1px solid #ff5a5a;border-radius:12px;padding:8px 12px;font-family:'Courier New',monospace;font-size:16px;color:#ff2a2a;text-shadow:0 0 2px #ffbbbb;letter-spacing:1px;z-index:101;box-shadow:0 4px 6px rgba(0,0,0,.05)}
        
        /* Shared Progress Containers */
        .progress-group-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            flex-direction: column;
            gap: 20px;
            width: 90%;
            max-width: 300px;
            z-index: 102;
        }
        .daily-progress-container, .spin-progress-container {
            background: #fff;
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,.1);
            text-align: center;
            border-left: 5px solid #4a90e2; 
        }
        .spin-progress-container {
            border-left: 5px solid #ff8c00; 
        }
        .daily-progress-text, .spin-progress-text {font-size:14px;color:#333;margin-bottom:4px; font-weight: bold;}
        .daily-progress-bar, .spin-progress-bar {width:100%;height:12px;background:rgba(0,0,0,.1);border-radius:10px;overflow:hidden;margin-top:6px}
        .daily-progress-fill {height:100%;background:linear-gradient(90deg,#00f2fe,#4facfe);border-radius:10px;width:0%;transition:width .4s ease}
        .spin-progress-fill {height:100%;background:linear-gradient(90deg,#ff8c00, #ff4500);border-radius:10px;width:0%;transition:width .4s ease}

        /* Button Adjustments - Equal width for 5 buttons */
        .button-container{
            position:absolute;bottom:40px;left:50%;transform:translateX(-50%);
            display:grid; /* Change to grid for better control */
            grid-template-columns: repeat(5, 1fr); /* 5 equal columns (UPDATED) */
            gap: 8px; /* Slightly reduced gap */
            background:rgba(240,240,240,.9);padding:10px 10px; /* Reduced padding */
            border-radius:20px;box-shadow:0 4px 15px rgba(0,0,0,.1);backdrop-filter:blur(10px);
            width: 95%; /* Increased width for more space */
            max-width: 450px;
        }
        .nav-button{
            position:relative;background:linear-gradient(145deg,#4a90e2,#357abd);color:#fff;border:none;padding:10px 0; /* Adjust padding for height control */
            border-radius:10px;font-size:11px; /* Reduced font size for better fit */
            font-weight:bold;cursor:pointer;transition:all .1s ease;
            flex-grow: 1;
            min-width: auto;
            text-transform:uppercase;letter-spacing:.5px;box-shadow:0 5px 0 #2c5aa0,0 8px 12px rgba(0,0,0,.15);transform:translateY(0);
            text-align: center;
            line-height: 1; /* Ensure text fits */
        }
        .nav-button:hover{transform:translateY(-1px);box-shadow:0 6px 0 #2c5aa0,0 10px 15px rgba(0,0,0,.2)}
        .nav-button:active{transform:translateY(2px);box-shadow:0 3px 0 #2c5aa0,0 5px 8px rgba(0,0,0,.15)}
        .nav-button span{display:block;text-shadow:0 1px 2px rgba(0,0,0,.3)}

        .nav-button.task-btn{
            background:linear-gradient(145deg,#ffc107,#ff9800);
            box-shadow:0 5px 0 #cc9a00,0 8px 12px rgba(0,0,0,.15);
        }
        .nav-button.task-btn:hover{box-shadow:0 6px 0 #cc9a00,0 10px 15px rgba(0,0,0,.2)}
        .nav-button.task-btn:active{box-shadow:0 3px 0 #cc9a00,0 5px 8px rgba(0,0,0,.15)}

        /* NEW Style for Withdraw Nav Button */
        .nav-button.withdraw-btn-nav{
            background:linear-gradient(145deg,#ff2a2a,#cc2121);
            box-shadow:0 5px 0 #991919,0 8px 12px rgba(0,0,0,.15);
        }
        .nav-button.withdraw-btn-nav:hover{box-shadow:0 6px 0 #991919,0 10px 15px rgba(0,0,0,.2)}
        .nav-button.withdraw-btn-nav:active{box-shadow:0 3px 0 #991919,0 5px 8px rgba(0,0,0,.15)}

        /* ===== Task Screen - REDESIGNED STYLING ===== */
        .task-screen{
            display:flex;
            flex-direction:column;
            align-items:center;
            justify-content: flex-start; 
            padding-top: 50px; 
            padding-bottom: 120px; 
            overflow-y: auto;
            background: #ffffed; /* Light, paper-like background */
        }
        .task-header{ 
            text-align: center;
            margin-bottom: 30px;
            width: 90%;
            max-width: 350px;
        }
        .task-title{ 
             font-family: 'Vazirmatn', sans-serif; 
             font-size:24px; 
             color:#333; /* Dark pencil color */
             font-weight:700; 
             text-shadow: 1px 1px 0 #fff; 
             border-bottom: 2px dashed #a0a0a0;
             padding-bottom: 10px;
        }
        
        /* New Task Card Style based on user's input (Paper Style) */
        .task-content-container {
            width: 100%;
            padding: 0 10px;
            max-width: 400px;
        }

        .task-item-card {
            background:#ffffff; /* White card */
            margin:10px 0;
            padding:18px;
            border-radius:10px;
            display:flex;
            justify-content:space-between;
            align-items:center;
            border: 1px solid #ddd; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        .task-text-info {
            color: #555; /* Slightly lighter text */
            font-size: 16px;
            font-weight: 500;
        }

        /* Button style from user's input (Pencil Style Action Button) */
        .task-action-btn-new {
            background:linear-gradient(145deg, #ffc107, #ff9800);
            border:1px solid #cc9a00;
            color:#fff;
            padding:10px 20px;
            border-radius:8px;
            cursor:pointer;
            font-size:1em;
            font-weight: bold;
            min-width: 90px; 
            transition: all 0.1s ease;
            box-shadow: 0 4px 0 #cc9a00;
            text-transform: uppercase;
        }
        .task-action-btn-new:hover {
            transform: translateY(-1px);
            box-shadow: 0 5px 0 #cc9a00;
        }
        .task-action-btn-new:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 #cc9a00;
        }
        .task-action-btn-new:disabled {
            background:#ccc;
            border-color:#aaa;
            color:#666;
            cursor:not-allowed;
            box-shadow: 0 4px 0 #aaa;
            transform: translateY(0);
        }
        
        .task-action-btn-new.completed {
            background:linear-gradient(145deg, #28a745, #1e7e34); /* Green for completed */
            border-color: #1c6d32;
            color: #fff;
            cursor: default;
            box-shadow: 0 4px 0 #1c6d32;
        }
        .task-action-btn-new.completed:disabled {
             background:linear-gradient(145deg, #1e7e34, #1c6d32); /* Darker green when disabled (after completion) */
             color: #ccc;
             box-shadow: 0 4px 0 #1c6d32;
        }
        
        /* Task Note style - REMOVED */
        .task-screen .note{ display: none; }

        /* Back Button Style - FIXED at bottom */
        .task-back-btn {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background:linear-gradient(145deg, #6c757d, #5a6268);
            color:#fff;border:none;padding:15px 40px; /* Larger padding */
            border-radius:12px;
            font-size:16px;
            font-weight:bold;
            cursor:pointer;
            box-shadow:0 6px 0 #4e555b; /* Larger shadow */
            transition:all .1s ease;
            width: 90%;
            max-width: 350px;
            z-index: 1000; /* Ensure it's above other elements */
        }
        .task-back-btn:active{transform:translateY(3px) translateX(-50%);box-shadow:0 3px 0 #4e555b}
        
        /* ===== Spin Screen ===== */
        .spin-screen{
            display:flex;flex-direction:column;align-items:center;justify-content:center;
            transition:opacity .3s ease;
        }
        #wheelBox{position:relative;margin-bottom:25px}
        #wheelCanvas{
            border-radius:50%;
            /* Enhanced 3D Look */
            box-shadow:0 0 0 10px #eee, 0 15px 35px rgba(0,0,0,0.4); 
            background-color: #fefefe; 
            border: 2px solid #ccc; 
        }
        .arrow{
            position:absolute;top:-16px;left:50%;transform:translateX(-50%);
            width:0;height:0;border-left:18px solid transparent;border-right:18px solid transparent;
            border-top:28px solid #ff3366;filter:drop-shadow(0 3px 2px rgba(0,0,0,.3));z-index:10;
        }
        .spin-btn{background:#ff3366;color:#fff;border:none;padding:12px 35px;border-radius:30px;font-size:16px;font-weight:bold;cursor:pointer;box-shadow:0 6px 0 #cc2950;transition:all .1s ease}
        .spin-btn:active{transform:translateY(3px);box-shadow:0 3px 0 #cc2950}
        .spin-result{margin-top:18px;font-size:18px;color:#333}
        .spin-back{margin-top:25px;background:#6c757d;color:#fff;border:none;padding:10px 25px;border-radius:8px;font-size:15px;font-weight:bold;cursor:pointer;box-shadow:0 4px 0 #5a6268}
        .spin-back:active{transform:translateY(2px);box-shadow:0 2px 0 #5a6268}

        /* ===== Withdraw Screen - (No changes needed) ===== */
        .withdraw-screen{
            display:flex;flex-direction:column;align-items:center;padding:20px 20px;
            transition:opacity .3s ease;
            overflow-y: auto;
        }
        .withdraw-header{
            text-align: center;
            margin-bottom: 25px;
            width: 100%;
            max-width: 400px;
            background: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 15px;
        }
        .withdraw-title{
            font-size:28px;color:#ff2a2a;font-weight:700; text-shadow: 0 1px 1px rgba(0,0,0,.1);
        }
        .current-balance-info{
            font-size: 16px;
            color: #555;
            margin-top: 10px;
            font-weight: bold;
        }
        .input-form-container {
            width: 100%;
            max-width: 400px;
            background: #fff;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 6px 20px rgba(0,0,0,.1);
            border: 1px solid #ddd;
            margin-bottom: 20px;
        }
        .input-group{
            width:100%;margin-bottom:15px;
        }
        .input-group label{display:block;margin-bottom:8px;font-size:14px;color:#555;font-weight:600;}
        .input-group input{width:100%;padding:12px 15px;border:1px solid #ddd;border-radius:10px;font-size:16px;transition:border-color .3s ease, box-shadow .3s ease;outline:none;}
        .input-group input:focus{border-color:#ff8c00;box-shadow:0 0 0 3px rgba(255,140,0,0.2);}
        .withdraw-buttons{display:flex;gap:15px;margin-top:20px;justify-content: center;}
        .withdraw-btn{
            background:linear-gradient(145deg, #28a745, #1e7e34);
            color:#fff;border:none;padding:12px 30px;border-radius:10px;font-size:16px;font-weight:bold;cursor:pointer;
            box-shadow:0 5px 0 #1c6d32;transition:all .1s ease;
            width: 100%;
        }
        .withdraw-btn:active{transform:translateY(3px);box-shadow:0 2px 0 #1c6d32}
        .back-btn{
            background:linear-gradient(145deg, #6c757d, #5a6268);
            color:#fff;border:none;padding:12px 30px;border-radius:10px;font-size:16px;font-weight:bold;cursor:pointer;
            box-shadow:0 5px 0 #4e555b;transition:all .1s ease;
        }
        .back-btn:active{transform:translateY(3px);box-shadow:0 2px 0 #4e555b}
        .note{margin-top:15px;font-size:13px;color:#777;max-width:400px;text-align:center;background:rgba(255,140,0,0.1);padding:10px;border-radius:10px;border-left: 5px solid #ff8c00;}

        /* Withdrawal History Table */
        .history-section{
            width: 100%;
            max-width: 400px;
            margin-top: 30px;
            padding: 20px 0;
            border-top: 1px solid #eee;
            background: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 15px;
        }
        .history-title{
            font-size: 20px;
            color: #333;
            margin-bottom: 15px;
            font-weight: 700;
            text-align: center;
        }
        .history-table{
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        .history-table th, .history-table td{
            padding: 10px;
            border-bottom: 1px solid #eee;
            text-align: left;
        }
        .history-table th{
            background-color: #f0f4f8;
            color: #4a90e2;
            ...

selectedRelevantSnippets:
snippet_1: <!DOCTYPE html> <html lang="en"> <head> <meta charset="UTF-8"> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <title>SHIB Ads WebApp</title> <script src="https://telegram.org/js/telegram-web-app.js"></script> <style> @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap'); @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap'); *{margin:0;padding:0;box-sizing:border-box} body{font-family:'Vazirmatn', Arial, Helvetica, sans-serif;overflow:hidden;background: #0d0c1d;} .app-screen { position: fixed; inset: 0; background: url('img.png') no-repeat center center; background-size: cover; transition: opacity .5s ease-in; display: flex; flex-direction: column; opacity: 0; pointer-events: none; z-index: 10; } .app-screen.visible { opacity: 1; pointer-events: auto; z-index: 20; } /* Loading Screen - Minimalistic Spinning Circle */ .loading-screen{ position:fixed;inset:0; background: #0d0c1d; display:flex;flex-direction:column;justify-content:center;align-items:center; z-index:9999;transition:opacity .5s ease-out; } .loading-screen.hidden{opacity:0;pointer-events:none} .spinner-circle { width: 80px; height: 80px; border: 8px solid rgba(255, 255, 255, 0.1); border-top: 8px solid #00ffff; /* Neon color */ border-radius: 50%; animation: spin 1.2s cubic-bezier(0.5, 0, 0.5, 1) infinite; box-shadow: 0 0 20px rgba(0, 255, 255, 0.6); /* Neon glow */ } @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } } /* End of Loading Screen */ /* Main Screen */ .main-screen{ background-color: #f0f0f0; } .main-content{flex:1;display:flex;justify-content:center;align-items:center} /* User Circle */ .user-circle{ position:absolute;top:20px;left:20px;width:70px;height:70px;border:2px dashed #ccc; border-radius:50%;display:flex;flex-direction:column;justify-content:center; align-items:center;cursor:pointer;transition:all .3s ease;z-index:100;overflow:hidden } .user-circle:hover{border-color:#4a90e2;background:rgba(74,144,226,.05)} .user-circle img{width:100%;height:100%;object-fit:cover;border-radius:50%;display:none} .user-circle .placeholder{color:#999;font-size:12px;text-align:center} .user-username{ position: absolute; top: 95px; left: 20px; width: 70px; font-size:13px;color:#555;white-space:nowrap; text-align: center; overflow: hidden; text-overflow: ellipsis; } .user-id{ position: absolute; top: 115px; left: 20px; width: 70px; font-size:11px;color:#888;white-space:nowrap; text-align: center; overflow: hidden; text-overflow: ellipsis; } .balance{position:absolute;top:20px;right:20px;background:#fff;border:1px solid #ff5a5a;border-radius:12px;padding:8px 12px;font-family:'Courier New',monospace;font-size:16px;color:#ff2a2a;text-shadow:0 0 2px #ffbbbb;letter-spacing:1px;z-index:101;box-shadow:0 4px 6px rgba(0,0,0,.05)} /* Shared Progress Containers */ .progress-group-container { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); display: flex; flex-direction: column; gap: 20px; width: 90%; max-width: 300px; z-index: 102; } .daily-progress-container, .spin-progress-container { background: #fff; padding: 15px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,.1); text-align: center; border-left: 5px solid #4a90e2; } .spin-progress-container { border-left: 5px solid #ff8c00; } .daily-progress-text, .spin-progress-text {font-size:14px;color:#333;margin-bottom:4px; font-weight: bold;} .daily-progress-bar, .spin-progress-bar {width:100%;height:12px;background:rgba(0,0,0,.1);border-radius:10px;overflow:hidden;margin-top:6px} .daily-progress-fill {height:100%;background:linear-gradient(90deg,#00f2fe,#4facfe);border-radius:10px;width:0%;transition:width .4s ease} .spin-progress-fill {height:100%;background:linear-gradient(90deg,#ff8c00, #ff4500);border-radius:10px;width:0%;transition:width .4s ease} /* Button Adjustments - Equal width for 5 buttons */ .button-container{ position:absolute;bottom:40px;left:50%;transform:translateX(-50%); display:grid; /* Change to grid for better control */ grid-template-columns: repeat(5, 1fr); /* 5 equal columns (UPDATED) */ gap: 8px; /* Slightly reduced gap */ background:rgba(240,240,240,.9);padding:10px 10px; /* Reduced padding */ border-radius:20px;box-shadow:0 4px 15px rgba(0,0,0,.1);backdrop-filter:blur(10px); width: 95%; /* Increased width for more space */ max-width: 450px; } .nav-button{ position:relative;background:linear-gradient(145deg,#4a90e2,#357abd);color:#fff;border:none;padding:10px 0; /* Adjust padding for height control */ border-radius:10px;font-size:11px; /* Reduced font size for better fit */ font-weight:bold;cursor:pointer;transition:all .1s ease; flex-grow: 1; min-width: auto; text-transform:uppercase;letter-spacing:.5px;box-shadow:0 5px 0 #2c5aa0,0 8px 12px rgba(0,0,0,.15);transform:translateY(0); text-align: center; line-height: 1; /* Ensure text fits */ } .nav-button:hover{transform:translateY(-1px);box-shadow:0 6px 0 #2c5aa0,0 10px 15px rgba(0,0,0,.2)} .nav-button:active{transform:translateY(2px);box-shadow:0 3px 0 #2c5aa0,0 5px 8px rgba(0,0,0,.15)} .nav-button span{display:block;text-shadow:0 1px 2px rgba(0,0,0,.3)} .nav-button.task-btn{ background:linear-gradient(145deg,#ffc107,#ff9800); box-shadow:0 5px 0 #cc9a00,0 8px 12px rgba(0,0,0,.15); } .nav-button.task-btn:hover{box-shadow:0 6px 0 #cc9a00,0 10px 15px rgba(0,0,0,.2)} .nav-button.task-btn:active{box-shadow:0 3px 0 #cc9a00,0 5px 8px rgba(0,0,0,.15)} /* NEW Style for Withdraw Nav Button */ .nav-button.withdraw-btn-nav{ background:linear-gradient(145deg,#ff2a2a,#cc2121); box-shadow:0 5px 0 #991919,0 8px 12px rgba(0,0,0,.15); } .nav-button.withdraw-btn-nav:hover{box-shadow:0 6px 0 #991919,0 10px 15px rgba(0,0,0,.2)} .nav-button.withdraw-btn-nav:active{box-shadow:0 3px 0 #991919,0 5px 8px rgba(0,0,0,.15)} /* ===== Task Screen - REDESIGNED STYLING ===== */ .task-screen{ display:flex; flex-direction:column; align-items:center; justify-content: flex-start; padding-top: 50px; padding-bottom: 120px; overflow-y: auto; background: #ffffed; /* Light, paper-like background */ } .task-header{ text-align: center; margin-bottom: 30px; width: 90%; max-width: 350px; } .task-title{ font-family: 'Vazirmatn', sans-serif; font-size:24px; color:#333; /* Dark pencil color */ font-weight:700; text-shadow: 1px 1px 0 #fff; border-bottom: 2px dashed #a0a0a0; padding-bottom: 10px; } /* New Task Card Style based on user's input (Paper Style) */ .task-content-container { width: 100%; padding: 0 10px; max-width: 400px; } .task-item-card { background:#ffffff; /* White card */ margin:10px 0; padding:18px; border-radius:10px; display:flex; justify-content:space-between; align-items:center; border: 1px solid #ddd; box-shadow: 0 4px 10px rgba(0,0,0,0.1); } .task-text-info { color: #555; /* Slightly lighter text */ font-size: 16px; font-weight: 500; } /* Button style from user's input (Pencil Style Action Button) */ .task-action-btn-new { background:linear-gradient(145deg, #ffc107, #ff9800); border:1px solid #cc9a00; color:#fff; padding:10px 20px; border-radius:8px; cursor:pointer; font-size:1em; font-weight: bold; min-width: 90px; transition: all 0.1s ease; box-shadow: 0 4px 0 #cc9a00; text-transform: uppercase; } .task-action-btn-new:hover { transform: translateY(-1px); box-shadow: 0 5px 0 #cc9a00; } .task-action-btn-new:active { transform: translateY(2px); box-shadow: 0 2px 0 #cc9a00; } .task-action-btn-new:disabled { background:#ccc; border-color:#aaa; color:#666; cursor:not-allowed; box-shadow: 0 4px 0 #aaa; transform: translateY(0); } .task-action-btn-new.completed { background:linear-gradient(145deg, #28a745, #1e7e34); /* Green for completed */ border-color: #1c6d32; color: #fff; cursor: default; box-shadow: 0 4px 0 #1c6d32; } .task-action-btn-new.completed:disabled { background:linear-gradient(145deg, #1e7e34, #1c6d32); /* Darker green when disabled (after completion) */ color: #ccc; box-shadow: 0 4px 0 #1c6d32; } /* Task Note style - REMOVED */ .task-screen .note{ display: none; } /* Back Button Style - FIXED at bottom */ .task-back-btn { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background:linear-gradient(145deg, #6c757d, #5a6268); color:#fff;border:none;padding:15px 40px; /* Larger padding */ border-radius:12px; font-size:16px; font-weight:bold; cursor:pointer; box-shadow:0 6px 0 #4e555b; /* Larger shadow */ transition:all .1s ease; width: 90%; max-width: 350px; z-index: 1000; /* Ensure it's above other elements */ } .task-back-btn:active{transform:translateY(3px) translateX(-50%);box-shadow:0 3px 0 #4e555b} /* ===== Spin Screen ===== */ .spin-screen{ display:flex;flex-direction:column;align-items:center;justify-content:center; transition:opacity .3s ease; } #wheelBox{position:relative;margin-bottom:25px} #wheelCanvas{ border-radius:50%; /* Enhanced 3D Look */ box-shadow:0 0 0 10px #eee, 0 15px 35px rgba(0,0,0,0.4); background-color: #fefefe; border: 2px solid #ccc; } .arrow{ position:absolute;top:-16px;left:50%;transform:translateX(-50%); width:0;height:0;border-left:18px solid transparent;border-right:18px solid transparent; border-top:28px solid #ff3366;filter:drop-shadow(0 3px 2px rgba(0,0,0,.3));z-index:10; } .spin-btn{background:#ff3366;color:#fff;border:none;padding:12px 35px;border-radius:30px;font-size:16px;font-weight:bold;cursor:pointer;box-shadow:0 6px 0 #cc2950;transition:all .1s ease} .spin-btn:active{transform:translateY(3px);box-shadow:0 3px 0 #cc2950} .spin-result{margin-top:18px;font-size:18px;color:#333} .spin-back{margin-top:25px;background:#6c757d;color:#fff;border:none;padding:10px 25px;border-radius:8px;font-size:15px;font-weight:bold;cursor:pointer;box-shadow:0 4px 0 #5a6268} .spin-back:active{transform:translateY(2px);box-shadow:0 2px 0 #5a6268} /* ===== Withdraw Screen - (No changes needed) ===== */ .withdraw-screen{ display:flex;flex-direction:column;align-items:center;padding:20px 20px; transition:opacity .3s ease; overflow-y: auto; } .withdraw-header{ text-align: center; margin-bottom: 25px; width: 100%; max-width: 400px; background: rgba(255, 255, 255, 0.9); padding: 15px; border-radius: 15px; } .withdraw-title{ font-size:28px;color:#ff2a2a;font-weight:700; text-shadow: 0 1px 1px rgba(0,0,0,.1); } .current-balance-info{ font-size: 16px; color: #555; margin-top: 10px; font-weight: bold; } .input-form-container { width: 100%; max-width: 400px; background: #fff; padding: 25px; border-radius: 15px; box-shadow: 0 6px 20px rgba(0,0,0,.1); border: 1px solid #ddd; margin-bottom: 20px; } .input-group{ width:100%;margin-bottom:15px; } .input-group label{display:block;margin-bottom:8px;font-size:14px;color:#555;font-weight:600;} .input-group input{width:100%;padding:12px 15px;border:1px solid #ddd;border-radius:10px;font-size:16px;transition:border-color .3s ease, box-shadow .3s ease;outline:none;} .input-group input:focus{border-color:#ff8c00;box-shadow:0 0 0 3px rgba(255,140,0,0.2);} .withdraw-buttons{display:flex;gap:15px;margin-top:20px;justify-content: center;} .withdraw-btn{ background:linear-gradient(145deg, #28a745, #1e7e34); color:#fff;border:none;padding:12px 30px;border-radius:10px;font-size:16px;font-weight:bold;cursor:pointer; box-shadow:0 5px 0 #1c6d32;transition:all .1s ease; width: 100%; } .withdraw-btn:active{transform:translateY(3px);box-shadow:0 2px 0 #1c6d32} .back-btn{ background:linear-gradient(145deg, #6c757d, #5a6268); color:#fff;border:none;padding:12px 30px;border-radius:10px;font-size:16px;font-weight:bold;cursor:pointer; box-shadow:0 5px 0 #4e555b;transition:all .1s ease; } .back-btn:active{transform:translateY(3px);box-shadow:0 2px 0 #4e555b} .note{margin-top:15px;font-size:13px;color:#777;max-width:400px;text-align:center;background:rgba(255,140,0,0.1);padding:10px;border-radius:10px;border-left: 5px solid #ff8c00;} /* Withdrawal History Table */ .history-section{ width: 100%; max-width: 400px; margin-top: 30px; padding: 20px 0; border-top: 1px solid #eee; background: rgba(255, 255, 255, 0.9); padding: 15px; border-radius: 15px; } .history-title{ font-size: 20px; color: #333; margin-bottom: 15px; font-weight: 700; text-align: center; } .history-table{ width: 100%; border-collapse: collapse; font-size: 14px; } .history-table th, .history-table td{ padding: 10px; border-bottom: 1px solid #eee; text-align: left; } .history-table th{ background-color: #f0f4f8; color: #4a90e2; ...
        }

        .history-table .status-Pending{ color: #ff8c00; font-weight: bold;}
        .history-table .status-Completed{ color: #28a745; font-weight: bold;}
        .no-records{text-align: center; color: #999; padding: 20px;}
        
        /* ===== Invite Screen - (No changes needed) ===== */
        .invite-screen{
            display:flex;flex-direction:column;align-items:center;padding:20px 20px;
            transition:opacity .3s ease;
            overflow-y: auto;
        }
        .invite-header{
            text-align: center;
            margin-bottom: 25px;
            width: 100%;
            max-width: 400px;
            background: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 15px;
        }
        .invite-title{
            font-size:28px;color:#4a90e2;font-weight:700; text-shadow: 0 1px 1px rgba(0,0,0,.1);
        }
        .referrals-count-info{
            font-size: 18px;
            color: #333;
            margin-top: 15px;
            font-weight: bold;
            padding: 10px 15px;
            background: #e6f0ff;
            border-radius: 10px;
            border: 1px solid #cce0ff;
            box-shadow: 0 2px 5px rgba(0,0,0,.05);
            width: 100%;
        }
        .input-form-container.invite-form {
            width: 100%;
            max-width: 400px;
            margin-bottom: 20px;
        }
        .invite-buttons{ width: 100%; margin-top: 15px; }
        .copy-link-btn{
            background:linear-gradient(145deg, #00bfff, #0077b3);
            color:#fff;border:none;padding:12px 30px;border-radius:10px;font-size:16px;font-weight:bold;cursor:pointer;
            box-shadow:0 5px 0 #005f99;transition:all .1s ease;
            width: 100%;
        }
        .copy-link-btn:active{transform:translateY(3px);box-shadow:0 2px 0 #005f99}


        /* ===== Custom Alert Box Styles (No changes needed) ===== */
        .custom-alert-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 99999; 
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .custom-alert-overlay.visible {
            opacity: 1;
            visibility: visible;
        }
        .custom-alert-box {
            background: #fff8e1; /* Light yellow/paper background */
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 350px;
            text-align: center;
            border: 2px solid #8B4513; /* Brown border for paper look */
            transform: scale(0.95);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .custom-alert-overlay.visible .custom-alert-box {
             transform: scale(1);
        }
        .alert-icon {
            font-size: 40px;
            margin-bottom: 15px;
        }
        .alert-icon::before {
             content: 'üîî'; /* Default Bell Icon */
        }
        .alert-title {
            font-size: 20px;
            font-weight: 700;
            color: #333;
            margin-bottom: 10px;
        }
        .alert-message {
            font-size: 14px;
            color: #555;
            white-space: pre-wrap;
            margin-bottom: 25px;
        }
        .alert-close-btn {
            background:linear-gradient(145deg, #a0522d, #8b4513); /* Sienna/Brown for OK button */
            color:#fff;
            border:none;
            padding:10px 25px;
            border-radius: 8px;
            font-size: 15px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 0 #543b27;
            transition: all 0.1s ease;
        }
        .alert-close-btn:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 #543b27;
        }
        /* Specific styles for Success */
        .custom-alert-box.success .alert-title {
            color: #28a745;
        }
        .custom-alert-box.success .alert-icon::before {
            content: 'üéÆ';
        }
        /* Specific styles for Error/Warning */
        .custom-alert-box.error .alert-title {
            color: #dc3545;
        }
        .custom-alert-box.error .alert-icon::before {
            content: 'ü§¶';
        }
        /* Specific styles for Warning/Info - Using Yellow/Brown for Pencil/Paper Theme */
        .custom-alert-box.warning .alert-title {
            color: #8B4513; /* Brown */
        }
        .custom-alert-box.warning .alert-icon::before {
            content: '‚úçÔ∏è'; /* Pencil/Writing Icon */
        }
    </style>
</head>
<body>
    <div class="loading-screen" id="loadingScreen">
        <div class="spinner-circle"></div>
    </div>
    
    <div class="app-screen main-screen" id="mainScreen">
        <div class="user-circle" onclick="circleClick()">
            <img id="userImage" alt="User Photo">
            <div class="placeholder">User</div>
        </div>
        <div class="user-username" id="userName">User Name</div>
        <div class="user-id" id="userId">ID: 0</div>
        
        <div class="balance" id="shibBalance">0 SHIB</div>

        <div class="progress-group-container">
            <div class="daily-progress-container">
                <div class="daily-progress-text">Ads today: <span id="adsCount">0</span> / 100</div>
                <div class="daily-progress-bar">
                    <div class="daily-progress-fill" id="dailyProgressFill"></div>
                </div>
            </div>
            <div class="spin-progress-container">
                <div class="spin-progress-text">Spins today: <span id="spinsCount">0</span> / 15</div>
                <div class="spin-progress-bar">
                    <div class="spin-progress-fill" id="spinProgressFill"></div>
                </div>
            </div>
        </div>

        <div class="button-container">
            <button class="nav-button" onclick="watchAds()">
                <span>Watch Ads</span>
            </button>
            <button class="nav-button task-btn" onclick="showTask()">
                <span>Task</span>
            </button>
            <button class="nav-button" onclick="showSpin()">
                <span>Spin</span>
            </button>
            <button class="nav-button" onclick="showInvite()">
                <span>Invite</span>
            </button>
            <button class="nav-button withdraw-btn-nav" onclick="showWithdraw()">
                <span>Withdraw</span>
            </button>
        </div>
    </div>

    <div class="app-screen" id="taskScreen">
        <div class="task-header">
            <div class="task-title">Daily Missions</div>
        </div>

        <div class="task-content-container">
            <div class="task-item-card" id="taskCard">
                <div class="task-text-info">
                    Join Telegram Channel
                    <br>
                    <small style="color: #4a90e2; font-weight: bold;">+50 SHIB</small>
                </div>
                <button id="taskActionBtn" class="task-action-btn-new" onclick="handleTaskAction()">
                    Join
                </button>
            </div>
        </div>
        
        <div class="task-header" style="margin-top: 20px;">
            <div class="task-title">Exclusive Tasks (New)</div>
        </div>
        <div class="task-content-container" id="newTaskContentContainer">
            <div class="no-tasks-message" id="noNewTasksMessage" style="text-align: center; color: #777; padding: 15px; display: none;">No exclusive tasks available at the moment.</div>
        </div>
        <button class="task-back-btn" onclick="hideTask()">Back to Main Screen</button>
    </div>

    <div class="app-screen" id="spinScreen">
        <div id="wheelBox">
            <canvas id="wheelCanvas" width="300" height="300"></canvas>
            <div class="arrow"></div>
        </div>
        <button id="spinBtn" class="spin-btn" onclick="startSpin()">SPIN</button>
        <div id="spinResult" class="spin-result">Ready to spin!</div>
    </div>

    <div class="app-screen" id="withdrawScreen">
        <div class="withdraw-header">
            <div class="withdraw-title">Withdrawal</div>
            <div class="current-balance-info">Current Balance: <span id="withdrawBalance">0 SHIB</span></div>
        </div>
        <div class="input-form-container">
            <div class="input-group">
                <label for="binanceIdInput">Binance Pay ID (Payer ID)</label>
                <input type="text" id="binanceIdInput" placeholder="Enter your Binance Pay ID" required>
            </div>
            <div class="input-group">
                <label for="amountInput">Amount to Withdraw (SHIB)</label>
                <input type="number" id="amountInput" placeholder="Minimum: 1,000" min="1000" required>
            </div>
            <div class="withdraw-buttons">
                <button class="withdraw-btn" onclick="requestWithdrawal()">Request Withdrawal</button>
            </div>
        </div>
        <div class="note">
            ‚ö†Ô∏è Minimum withdrawal amount is 1,000 SHIB. Payments are processed to your Binance Pay ID within 24 hours.
        </div>

        <div class="history-section">
            <div class="history-title">Withdrawal History</div>
            <table class="history-table" id="withdrawalHistoryTable">
                <thead>
                    <tr>
                        <th>Amount</th>
                        <th>Status</th>
                        <th>Date</th>
                    </tr>
                </thead>
                <tbody id="withdrawalHistoryBody">
                    </tbody>
            </table>
            <div id="noHistory" class="no-records" style="display: none;">No withdrawal records found.</div>
        </div>
        <button class="back-btn" style="margin-top: 20px;" onclick="hideWithdraw()">Back to Main</button>
    </div>

    <div class="app-screen" id="inviteScreen">
        <div class="invite-header">
            <div class="invite-title">Invite & Earn</div>
            <div class="referrals-count-info">Your Referrals: <span id="referralsCount">0</span> users</div>
        </div>
        <div class="input-form-container invite-form">
            <div class="input-group">
                <label>Your Referral Link</label>
                <input type="text" id="referralLinkInput" readonly value="Generating Link...">
            </div>
            <div class="invite-buttons">
                <button class="copy-link-btn" onclick="copyReferralLink()">Copy Link</button>
            </div>
        </div>
        <div class="note">
            üöÄ Share this link to invite new users. You will earn 5% of the revenue from every referral you bring through ads!
        </div>
        <button class="back-btn" onclick="hideInvite()">Back to Main</button>
    </div>

    <div id="customAlert" class="custom-alert-overlay">
        <div class="custom-alert-box">
            <div class="alert-icon" id="alertIcon"></div>
            <div class="alert-title" id="alertTitle"></div>
            <div class="alert-message" id="alertMessage"></div>
            <button class="alert-close-btn" onclick="document.getElementById('customAlert').classList.remove('visible')">OK</button>
        </div>
    </div>

    <audio id="backgroundAudio" loop>
        <source src="audio.mp3" type="audio/mp3">
        Your browser does not support the audio element.
    </audio>
    <audio id="successSFX">
        <source src="success.mp3" type="audio/mp3">
    </audio>
    <audio id="errorSFX">
        <source src="error.mp3" type="audio/mp3">
    </audio>
    <script src='//libtl.com/sdk.js' data-zone='10245709' data-sdk='show_10245709' data-dzone='10245709'></script>
    <script>
        /* =============================================================== */
        /* =================== ORIGINAL SCRIPT START ===================== */
        /* =============================================================== */

        /* ===== Telegram User & Referral Setup (Modified to include audio) ===== */
        Telegram.WebApp.ready();
        let tgUser = null;
        if(Telegram.WebApp.initDataUnsafe && Telegram.WebApp.initDataUnsafe.user){
            tgUser = Telegram.WebApp.initDataUnsafe.user;
            const photoUrl = tgUser.photo_url;
            const userName = tgUser.first_name + (tgUser.last_name? ' '+tgUser.last_name:'');
            const userId = tgUser.id;
            
            const imgEl = document.getElementById('userImage');
            const nameEl = document.getElementById('userName');
            const idEl = document.getElementById('userId');
            const placeHolder = document.querySelector('.placeholder');

            if(photoUrl){
                imgEl.src = photoUrl;
                imgEl.style.display = 'block';
                placeHolder.style.display = 'none';
            }
            nameEl.textContent = userName;
            idEl.textContent = 'ID: ' + userId;
        }

        function getRefParam() {
            let referrerId = null;
            const REF_PREFIX = 'ref_';
            if (Telegram.WebApp.initDataUnsafe && Telegram.WebApp.initDataUnsafe.start_param) {
                const startParam = Telegram.WebApp.initDataUnsafe.start_param;
                if (startParam.startsWith(REF_PREFIX)) {
                    referrerId = startParam.substring(REF_PREFIX.length);
                    console.log('Referrer ID from start_param:', referrerId);
                }
            }
            return referrerId;
        }

        let referrerId = getRefParam();
        const API_URL = 'api/index.js'; // The Vercel function endpoint

        /* ===== State Management & Constants ===== */
        const DAILY_MAX = 100;
        const DAILY_MAX_SPINS = 15;
        let isBanned = false;
        let isProcessingTask = false; // Flag to prevent double-click during task claim countdown
        let countdownInterval = null; // For the task countdown timer
        let taskCompleted = false; // For the original channel join task
        
        // State for the two-step action on the original task screen: 'JOIN_OR_CLAIM', 'CLAIM', 'COMPLETED'
        let taskActionState = 'JOIN_OR_CLAIM'; 
        
        let appState = {
            balance: 0,
            ads_watched_today: 0,
            spins_today: 0,
            referrals_count: 0,
            withdrawal_history: []
        };

        function updateState(newState) {
            appState = { ...appState, ...newState };
            updateUI();
        }
        
        function updateUI() {
            if (!document.getElementById('shibBalance')) return; // Exit if UI not ready

            document.getElementById('shibBalance').textContent = appState.balance.toLocaleString('en-US', { maximumFractionDigits: 8 }) + ' SHIB';
            document.getElementById('adsCount').textContent = appState.ads_watched_today.toLocaleString();
            document.getElementById('spinsCount').textContent = appState.spins_today.toLocaleString();

            initDailyProgress(appState.ads_watched_today);
            initSpinProgress(appState.spins_today);
            displayWithdrawals();
            displayReferrals();
            updateTaskButton(); // Update original task button

            // Ensure Telegram MainButton is hidden on the main screen
            if (document.getElementById('mainScreen').classList.contains('visible') && Telegram.WebApp.MainButton.isVisible) {
                 Telegram.WebApp.MainButton.hide();
            }
        }
        
        /* ===== Custom Alert Logic ===== */
        function playSFX(type) {
             const audioEl = document.getElementById(type + 'SFX');
             if (audioEl) {
                audioEl.currentTime = 0;
                audioEl.play().catch(e => console.log(`Audio playback failed for ${type}:`, e));
             }
        }
        
        function showCustomAlert(title, message, type = 'info') {
            const overlay = document.getElementById('customAlert');
            const box = document.querySelector('.custom-alert-box');
            
            // Reset classes
            box.className = 'custom-alert-box';
            
            // Set type specific styles and play sound
            box.classList.add(type);
            if (type === 'success') {
                playSFX('success');
            } else if (type === 'error') {
                playSFX('error');
            }
            
            document.getElementById('alertTitle').textContent = title;
            document.getElementById('alertMessage').textContent = message;
            overlay.classList.add('visible');
        }

        /* ===== API Fetch Wrapper (No change) ===== */
        async function fetchApi(payload) {
            if (!tgUser) {
                showCustomAlert('Error!', 'Telegram user data is missing. Please restart the app.', 'error');
                return { ok: false, error: 'No user data' };
            }

            if (typeof Telegram.WebApp.showProgress === 'function') {
                Telegram.WebApp.showProgress(false); // Show indefinite loading indicator
            }

            try {
                const initData = Telegram.WebApp.initData;
                const body = { ...payload, user_id: tgUser.id, initData };

                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                
                if (typeof Telegram.WebApp.hideProgress === 'function') {
                    Telegram.WebApp.hideProgress();
                }

                const data = await response.json();

                if (!response.ok || !data.ok) {
                    const errorMessage = data.error || `Server error (Status: ${response.status})`;
                    console.error(`API Error for type ${payload.type}:`, errorMessage);

                    let alertTitle;
                    let cleanMessage;
                    let alertType = 'error';
                    
                    if (response.status === 401) {
                         alertTitle = 'Security Error!';
                         cleanMessage = 'Security check failed. Please refresh the page.';
                    } else if (response.status === 429) {
                         alertTitle = 'Too Fast!';
                         alertType = 'warning';
                         cleanMessage = 'You are performing actions too quickly. Please wait a moment.';
                    } else if (response.status === 409 || response.status === 408) {
                        alertTitle = 'Security Error!';
                        alertType = 'error';
                        cleanMessage = 'A security-related error occurred. Please try again.';
                    } else if (payload.type === 'completeTask' && errorMessage.includes('already completed')) {
                        alertTitle = 'Task Completed!';
                        alertType = 'warning';
                        cleanMessage = 'Reward already claimed. Task is complete.';
                    } else if (payload.type === 'completeTask' && errorMessage.includes('not joined')) {
                        alertTitle = 'Task Failed!';
                        alertType = 'error';
                        cleanMessage = 'Membership not verified. Please ensure you joined the channel and try again.';
                    } else {
                        // General error handling (English)
                        alertTitle = 'Operation Failed!';
                        alertType = 'error';
                        cleanMessage = errorMessage;
                    }
                    
                    showCustomAlert(alertTitle, cleanMessage, alertType);
                    return { ok: false, error: errorMessage };
                }

                return data;

            } catch (error) {
                if (typeof Telegram.WebApp.hideProgress === 'function') {
                    Telegram.WebApp.hideProgress();
                }
                console.error(`General Fetch Error for type ${payload.type}:`, error.message);
                // English translation of the Arabic alert message
                showCustomAlert('Connection Error!', 'Could not connect to the server. Please check your internet connection.', 'error');
                return { ok: false, error: error.message };
            }
        }
        
        // ------------------------------------------------------------------
        // NEW: Function to request Action ID from the Server
        // ------------------------------------------------------------------
        async function requestActionId(actionType) {
            const result = await fetchApi({ type: 'generateActionId', action_type: actionType });
            if (result.ok) {
                return result.data.action_id;
            }
            return null;
        }

        /* ===== Initial Load ===== */
        async function loadAll() {
            // 1. Register or Check User (always the first call)
            if (tgUser) {
                const registerResult = await fetchApi({ 
                    type: 'register', 
                    user_id: tgUser.id,
                    ref_by: referrerId
                });
                if (!registerResult.ok) {
                    document.getElementById('loadingScreen').classList.add('hidden');
                    return; // Stop if registration/check fails
                }
            } else {
                showCustomAlert('Error!', 'Telegram user data is missing. Please restart the app.', 'error');
                document.getElementById('loadingScreen').classList.add('hidden');
                return;
            }

            // 2. Load User Data
            await loadUserData();

            // 3. Hide loading screen
            document.getElementById('loadingScreen').classList.add('hidden');
        }

        /* ===== User Data Loading (No change) ===== */
        async function loadUserData() {
            if (!tgUser) return;
            const result = await fetchApi({ type: 'getUserData' });

            if (result.ok) {
                if (result.data.is_banned) {
                    isBanned = true;
                    mainScreen.classList.remove('visible');
                    // English translation of the Arabic alert message
                    showCustomAlert('Account Banned!', 'This account has been permanently restricted for violating policies. Access to the Mini App is denied.', 'error');
                    return;
                }

                taskCompleted = result.data.task_completed || false;
                
                updateState({
                    balance: result.data.balance,
                    ads_watched_today: result.data.ads_watched_today,
                    spins_today: result.data.spins_today,
                    referrals_count: result.data.referrals_count,
                    is_banned: false,
                    withdrawal_history: (result.data.withdrawal_history || []).map(item => ({
                        amount: item.amount,
                        status: item.status,
                        date: new Date(item.created_at).toLocaleDateString('en-GB')
                    }))
                });

                // Set taskActionState based on loaded data
                if (taskCompleted) {
                    taskActionState = 'COMPLETED';
                } else if (taskActionState === 'COMPLETED') { 
                    // Prevents resetting to COMPLETED if an error occurred during claim
                    taskActionState = 'JOIN_OR_CLAIM'; 
                }

                mainScreen.classList.add('visible');
            }
        }
        
        /* ===== Progress Bars (No change) ===== */
        async function initDailyProgress(count) {
            const percentage = Math.min(100, (count / DAILY_MAX) * 100);
            document.getElementById('dailyProgressFill').style.width = percentage + '%';
        }

        async function initSpinProgress(count) {
            const percentage = Math.min(100, (count / DAILY_MAX_SPINS) * 100);
            document.getElementById('spinProgressFill').style.width = percentage + '%';
        }

        /* ===== Watch Ads (No change) ===== */
        async function watchAds(){
            if (isBanned) {
                // English translation of the Arabic alert message
                showCustomAlert('Access Denied!', 'This account has been banned.', 'error');
                return;
            }

            if (appState.ads_watched_today >= DAILY_MAX) {
                showCustomAlert('Daily Limit Reached!', `Ôº°Ôº¨Ôº¨ ÔΩÅÔΩÑÔΩì Ôº§ÔΩèÔΩéÔΩÖ (${DAILY_MAX}). Ôº£ÔΩèÔΩçÔΩÖ ÔΩÇÔΩÅÔΩÉÔΩã Ôº°ÔΩÜÔΩîÔΩÖÔΩí 6 Ôº®ÔΩèÔΩïÔΩíÔΩìü•©!`, 'warning');
                return;
            }

            // 1. Request Action ID from the Server
            const actionId = await requestActionId('watchAd');
            if (!actionId) return; // Error message already shown by fetchApi

            // 2. Show First Ad - NO ALERT HERE
            show_10245709()
                .then(() => {
                    // Success for Ad 1 - Immediately start the second ad - NO ALERT HERE
                    return show_10245709();
                })
                .then(async () => {
                    // Success for Ad 2 - Now process reward
                    const result = await fetchApi({
                        type: 'watchAd',
                        action_id: actionId // ‚¨ÖÔ∏è Send Action ID
                    });

                    if (result.ok) {
                        playSFX('success');
                        // 3. Update balance and ads count with trusted server values
                        updateState({
                            balance: result.data.new_balance,
                            ads_watched_today: result.data.new_ads_count
                        });

                        // English translation of the Arabic alert message
                        showCustomAlert('Success! üí∞', 
                                        `${result.data.actual_reward} SHIB added. Ads completed: ${result.data.new_ads_count}/${DAILY_MAX}.`, 
                                        'success');
                    } else {
                        // If backend fails, reload data to ensure state consistency
                        loadUserData(); 
                    }
                })
                .catch(async (e) => {
                    // Ad error/cancellation handling
                    if (typeof e === 'string' && e.includes('canceled')) {
                        // English translation of the Arabic alert message
                        showCustomAlert('Ad Cancelled/Failed!', 'The ad was not watched completely. The attempt was not counted.', 'warning');
                    } else {
                        // English translation of the Arabic alert message
                        showCustomAlert('Ad Load Failed!', 'One of the ads failed to load. Please try again.', 'error');
                    }
                    loadUserData();
                });
        }
        
        /* ===== Task Screen Functions (Original Task) (No change) ===== */
        function updateTaskButton() {
            const taskBtn = document.getElementById('taskActionBtn');
            const taskCard = document.getElementById('taskCard');
            if (!taskBtn || !taskCard) return;

            taskBtn.disabled = false;
            taskCard.classList.remove('completed');

            if (taskCompleted) {
                taskActionState = 'COMPLETED';
            }

            switch (taskActionState) {
                case 'COMPLETED':
                    taskBtn.textContent = 'Completed';
                    taskBtn.disabled = true;
                    taskBtn.classList.add('completed');
                    taskCard.classList.add('completed');
                    break;
                case 'CLAIM':
                    taskBtn.textContent = 'Claim';
                    taskBtn.classList.remove('completed');
                    break;
                case 'JOIN_OR_CLAIM':
                default:
                    taskBtn.textContent = 'Join';
                    taskBtn.classList.remove('completed');
                    break;
            }
        }
        
        async function claimTaskReward(){
            const taskBtn = document.getElementById('taskActionBtn');
            if (isBanned || taskCompleted) return;
            if (isProcessingTask) return;
            
            isProcessingTask = true;
            updateUI(); 

            const countdownTime = 5;
            let countdown = countdownTime;
            
            // Start the countdown on the button
            const interval = setInterval(() => {
                countdown--;
                taskBtn.textContent = `Claim in ${countdown}s`;
                if (countdown <= 0) {
                    clearInterval(interval);
                    taskBtn.textContent = 'Verifying...';
                    processClaim();
                }
            }, 1000);
            
            countdownInterval = interval; // Save for clearing when leaving screen
            
            async function processClaim() {
                const actionId = await requestActionId('completeTask');
                if (!actionId) {
                    isProcessingTask = false;
                    clearInterval(countdownInterval);
                    taskActionState = 'JOIN_OR_CLAIM'; // Reset state on API error
                    updateUI();
                    return;
                }

                const result = await fetchApi({
                    type: 'completeTask',
                    action_id: actionId // ‚¨ÖÔ∏è Send Action ID
                });

                isProcessingTask = false;
                
                if (result.ok) {
                    // Success
                    updateState({ balance: result.data.new_balance });
                    taskCompleted = true;
                    taskActionState = 'COMPLETED';
                    showCustomAlert('Success! üí∞', `${result.data.actual_reward} SHIB has been added to your balance.`, 'success');
                } else if (result.error && (result.error.includes('already completed') || result.error.includes('not joined'))) {
                    // If the server returns an error about completion or not joined, reset to first state
                    loadUserData();
                    taskActionState = 'JOIN_OR_CLAIM'; // Force restart the process
                    taskBtn.textContent = 'Join'; // Reset button text manually in case loadUserData fails
                }
                updateUI();
            }
        }
        
        // NEW function to handle the two-step action
        function handleTaskAction() {
            const taskBtn = document.getElementById('taskActionBtn');
            if (taskCompleted) {
                showCustomAlert('Task Completed!', 'Reward already claimed. Task is complete.', 'warning');
                return;
            }
            if (isProcessingTask) return; // Prevent double clicking during claim process

            const channelLink = 'https://t.me/botbababab';
            
            if (taskActionState === 'JOIN_OR_CLAIM') {
                // First click: Redirect to the channel
                taskBtn.disabled = true; // Disable temporarily while opening link
                taskBtn.textContent = 'Joining...';
                
                // Use Telegram WebApp function if available, otherwise fallback
                if (typeof Telegram.WebApp.openTelegramLink === 'function') {
                    Telegram.WebApp.openTelegramLink(channelLink);
                } else {
                    window.open(channelLink, '_blank');
                }

                // Update state and UI to prompt for the second click (claim)
                // Re-enable and set state after a small delay to ensure link opens
                setTimeout(() => {
                    taskActionState = 'CLAIM';
                    taskBtn.disabled = false;
                    taskBtn.textContent = 'Claim';
                    
                    // Show an instruction alert (PENCIL STYLE)
                    showCustomAlert('Action Required!', 
                                    'After joining the channel in the new window, click "Claim" to confirm your membership and get the reward.', 
                                    'warning');
                }, 1000); 

            } else if (taskActionState === 'CLAIM') {
                // Second click: Initiate the claim countdown
                claimTaskReward();
            }
            updateUI();
        }


        /* ===== Navigation (No change to original logic) ===== */
        const mainScreen = document.getElementById('mainScreen');
        
        function showTask(){ 
            if (isBanned) {
                showCustomAlert('Access Denied!', 'This account has been banned.', 'error');
                return;
            }
            mainScreen.classList.remove('visible');
            document.getElementById('taskScreen').classList.add('visible');
            loadUserData();
            // ‚¨áÔ∏è NEW CODE ADDITION START
            loadNewTasks(); // Load the new tasks
            // ‚¨ÜÔ∏è NEW CODE ADDITION END
        }

        function hideTask(){
            // Clear any running countdown when leaving the screen
            if (countdownInterval) {
                clearInterval(countdownInterval);
                countdownInterval = null;
                isProcessingTask = false;
                taskActionState = taskCompleted ? 'COMPLETED' : 'JOIN_OR_CLAIM'; // Reset state
                updateUI();
            }
            document.getElementById('taskScreen').classList.remove('visible');
            mainScreen.classList.add('visible');
        }

        function showSpin(){
            if (isBanned) {
                // English translation of the Arabic alert message
                showCustomAlert('Access Denied!', 'This account has been banned.', 'error');
                return;
            }
            mainScreen.classList.remove('visible');
            document.getElementById('spinScreen').classList.add('visible');
            loadUserData();
            updateUI();
        }

        function hideSpin(){
            document.getElementById('spinScreen').classList.remove('visible');
            mainScreen.classList.add('visible');
        }

        function showWithdraw(){
            if (isBanned) {
                // English translation of the Arabic alert message
                showCustomAlert('Access Denied!', 'This account has been banned.', 'error');
                return;
            }
            document.getElementById('withdrawBalance').textContent = appState.balance.toLocaleString('en-US', { maximumFractionDigits: 8 }) + ' SHIB';
            mainScreen.classList.remove('visible');
            document.getElementById('withdrawScreen').classList.add('visible');
        }

        function hideWithdraw(){
            document.getElementById('withdrawScreen').classList.remove('visible');
            mainScreen.classList.add('visible');
        }

        function showInvite(){
            if (isBanned) {
                // English translation of the Arabic alert message
                showCustomAlert('Access Denied!', 'This account has been banned.', 'error');
                return;
            }
            // Generate link dynamically
            const botUsername = Telegram.WebApp.initDataUnsafe.user.username || 'your_bot_username'; 
            const referralLink = `https://t.me/${botUsername}?start=ref_${tgUser.id}`;
            document.getElementById('referralLinkInput').value = referralLink;
            document.getElementById('referralsCount').textContent = appState.referrals_count.toLocaleString();
            
            mainScreen.classList.remove('visible');
            document.getElementById('inviteScreen').classList.add('visible');
        }

        function hideInvite(){
            document.getElementById('inviteScreen').classList.remove('visible');
            mainScreen.classList.add('visible');
        }


        // ‚¨áÔ∏è NEW CODE ADDITION START: NEW Task System Functions
        
        let newTasks = []; // Global state for the new tasks list

        /**
         * NEW: Fetches and displays the new tasks list.
         */
        async function loadNewTasks() {
            if (!tgUser) return;
            const container = document.getElementById('newTaskContentContainer');
            const noTasksMessage = document.getElementById('noNewTasksMessage');
            container.innerHTML = ''; // Clear previous tasks

            const result = await fetchApi({ type: 'getNewTasks' });
            
            if (result.ok && result.data.tasks) {
                newTasks = result.data.tasks;
                if (newTasks.length === 0) {
                    noTasksMessage.style.display = 'block';
                    return;
                }

                noTasksMessage.style.display = 'none';

                newTasks.forEach(task => {
                    const isCompleted = task.is_completed;
                    const isFull = task.current_users >= task.max_users;
                    
                    let btnText = 'Complete';
                    let btnClass = 'task-action-btn-new';
                    let btnDisabled = false;
                    let btnAction = `handleNewTaskAction(${task.id}, '${task.task_url}')`;

                    if (isCompleted) {
                        btnText = 'Completed';
                        btnClass += ' completed';
                        btnDisabled = true;
                        btnAction = `showCustomAlert('Task Completed!', 'Reward already claimed.', 'warning')`;
                    } else if (isFull) {
                        btnText = 'Limit Reached';
                        btnClass += ' completed'; // Use completed style to show it's locked
                        btnDisabled = true;
                        btnAction = `showCustomAlert('Limit Reached!', 'This task has reached its maximum user limit.', 'error')`;
                    }
                    // If task is not completed and not full, use default 'Complete' button

                    const taskHtml = `
                        <div class="task-item-card" data-task-id="${task.id}">
                            <div class="task-text-info">
                                ${task.task_name}
                                <br>
                                <small style="color: #ff2a2a; font-weight: bold;">+${task.task_reward.toLocaleString('en-US', { maximumFractionDigits: 8 })} SHIB</small>
                                <small style="color: #999; display: block; margin-top: 5px;">
                                    Slots: ${task.current_users.toLocaleString()}/${task.max_users.toLocaleString()}
                                </small>
                            </div>
                            <button id="newTaskBtn_${task.id}" class="${btnClass}" ${btnDisabled ? 'disabled' : ''} onclick="${btnAction}">
                                ${btnText}
                            </button>
                        </div>
                    `;
                    container.innerHTML += taskHtml;
                });
            } else {
                noTasksMessage.textContent = 'Failed to load exclusive tasks.';
                noTasksMessage.style.display = 'block';
            }
        }

        /**
         * NEW: Handles the two-step action for new tasks: redirect and then claim.
         */
        async function handleNewTaskAction(taskId, taskUrl) {
            const taskBtn = document.getElementById(`newTaskBtn_${taskId}`);
            const task = newTasks.find(t => t.id === taskId);
            if (!task) return;

            // 1. Redirect to URL
            taskBtn.disabled = true;
            taskBtn.textContent = 'Redirecting...';
            
            // Use Telegram WebApp function if available, otherwise fallback
            if (typeof Telegram.WebApp.openLink === 'function') {
                Telegram.WebApp.openLink(taskUrl);
            } else {
                window.open(taskUrl, '_blank');
            }

            // 2. Prompt for Claim after redirect
            showCustomAlert('Action Required!', 
                'After completing the task (e.g., joining a group, following a page) in the new window, click "Claim Reward" to confirm.', 
                'warning');

            // Wait a brief moment, then change the button to 'Claim Reward'
            setTimeout(() => {
                taskBtn.textContent = 'Claim Reward';
                taskBtn.disabled = false;
                taskBtn.onclick = () => claimNewTaskReward(taskId);
            }, 1500);
        }

        /**
         * NEW: Claims the reward for a new task after the user has performed the action.
         */
        async function claimNewTaskReward(taskId) {
            const taskBtn = document.getElementById(`newTaskBtn_${taskId}`);
            if (isBanned || taskBtn.disabled) return;
            
            // Use the existing security flow: generate action ID, then claim
            const actionId = await requestActionId('completeNewTask');
            if (!actionId) return;

            taskBtn.disabled = true;
            taskBtn.textContent = 'Processing...';

            const result = await fetchApi({
                type: 'completeNewTask',
                task_id: taskId,
                action_id: actionId
            });

            if (result.ok) {
                // Success: Update state, display alert, reload tasks
                updateState({ balance: result.data.new_balance });
                
                showCustomAlert('Success! üí∞', 
                    `${result.data.actual_reward.toLocaleString()} SHIB has been added to your balance.`, 
                    'success');
                    
                // Reload all data to update the UI
                await loadUserData(); 
                await loadNewTasks(); 

            } else {
                // Handle specific errors from the backend: already completed, limit reached
                let alertTitle = 'Operation Failed!';
                let cleanMessage = result.error;
                let alertType = 'error';

                if (result.error && result.error.includes('already completed')) {
                    alertTitle = 'Task Completed!';
                    alertType = 'warning';
                    cleanMessage = 'Reward already claimed. Task is complete.';
                } else if (result.error && result.error.includes('Task limit reached')) {
                    alertTitle = 'Task Limit Reached!';
                    alertType = 'error';
                    cleanMessage = 'This task has reached its maximum user limit.';
                }
                
                showCustomAlert(alertTitle, cleanMessage, alertType);

                // On error, revert button state or reload to reflect current status
                await loadNewTasks();
            }
        }
        
        // ‚¨ÜÔ∏è NEW CODE ADDITION END

        /* ===== Spin Wheel (Wheel Code) (No changes needed) ===== */
        const sectors = [5, 10, 15, 20, 5]; // Match server sectors
        const colors = ['#00bfff', '#ff8c00', '#28a745', '#ff4500', '#00f2fe']; 
        const prizeValues = sectors; 
        const canvas = document.getElementById('wheelCanvas');
        const ctx = canvas.getContext('2d');
        const spinResult = document.getElementById('spinResult');
        const spinBtn = document.getElementById('spinBtn');
        let spinning = false;
        let currentAngle = 0;

        function drawWheel() {
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = 130;
            const sectorCount = sectors.length;
            const arc = 2 * Math.PI / sectorCount;
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.font = '24px Vazirmatn, sans-serif'; // Set font size for emoji
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';

            sectors.forEach((prize, i) => {
                const angle = i * arc;
                
                // Draw sector arc
                ctx.beginPath();
                ctx.arc(centerX, centerY, radius, angle, angle + arc);
                ctx.lineTo(centerX, centerY);
                ctx.fillStyle = colors[i % colors.length];
                ctx.fill();
                
                // Draw text/prize value
                ctx.save();
                ctx.translate(centerX, centerY);
                ctx.rotate(angle + arc / 2);
                
                // Set text color for better contrast
                ctx.fillStyle = '#fff';
                
                // Position the text slightly in from the edge
                const textX = radius * 0.65;
                
                // Draw the value (SHIB)
                ctx.font = '16px Vazirmatn, sans-serif'; 
                ctx.fillText(prize + ' SHIB', textX, 0);

                ctx.restore();
            });

            // Draw center circle (hub)
            ctx.beginPath();
            ctx.arc(centerX, centerY, 20, 0, 2 * Math.PI);
            ctx.fillStyle = '#ff3366';
            ctx.fill();
            ctx.strokeStyle = '#fff';
            ctx.lineWidth = 3;
            ctx.stroke();

            // Draw center text
            ctx.fillStyle = '#fff';
            ctx.font = 'bold 14px Arial';
            ctx.fillText('GO', centerX, centerY + 2);
        }

        function rotateWheel(finalPrizeIndex) {
            const sectorCount = sectors.length;
            const arc = 2 * Math.PI / sectorCount;
            // Target angle for the prize sector to land under the arrow (at 12 o'clock/3pi/2)
            // We need to account for the rotation being clockwise (positive angle)
            // The center of the winning sector should be 90 degrees (pi/2) past the 12 o'clock position
            // The sectors are drawn starting at 0 degrees (3 o'clock)
            // A winning index 'i' has its center at angle: i * arc + arc / 2
            
            // To make the center of sector 'i' land at the arrow position (270 degrees or -90 degrees from top):
            // We want the rotation angle (in radians) to be:
            // 2*pi - (i * arc + arc / 2) + 2*pi*N + offset
            
            // Let's use degrees for simplicity for the target:
            // Arrow is at 270 degrees from 3 o'clock (0 deg) when viewed clockwise.
            // Center of sector 'i' is at: (i * 360/N + 360/(2N)) degrees.
            // Target is: Rotation + CurrentAngle = 360*N + (360 - TargetCenterAngle + 270)
            
            const degreesPerSector = 360 / sectorCount;
            const targetCenterAngle = finalPrizeIndex * degreesPerSector + degreesPerSector / 2; // Angle of prize center (from 3 o'clock)
            const degreesToRotate = 360 - targetCenterAngle + 90; // The 90 degrees shifts the target center from 3 o'clock to 12 o'clock
            
            // Add many full rotations (e.g., 5 full spins = 1800 deg)
            const extraRotations = 1800; 
            const finalDegrees = extraRotations + degreesToRotate;
            
            const finalRadians = finalDegrees * (Math.PI / 180);
            
            // CSS transition for rotation
            const wheelBox = document.getElementById('wheelBox');
            wheelBox.style.transition = 'transform 4s cubic-bezier(0.2, 0.7, 0.4, 1)'; // Slower start, fast finish
            wheelBox.style.transform = `rotate(${finalDegrees}deg)`;
            
            // Store the final angle to ensure subsequent spins start from the correct position
            currentAngle = finalDegrees % 360; 

            // Handle end of spin
            setTimeout(() => {
                spinning = false;
                spinBtn.disabled = false;
                spinBtn.textContent = 'SPIN AGAIN';
                
                // Reset transition and rotate back to the clean angle for next spin
                wheelBox.style.transition = 'none';
                wheelBox.style.transform = `rotate(${currentAngle}deg)`;
            }, 4000);
        }

        function startSpin() {
            if (isBanned) {
                showCustomAlert('Access Denied!', 'This account has been banned.', 'error');
                return;
            }
            if (appState.spins_today >= DAILY_MAX_SPINS) {
                return;
            }

            // Reset current rotation instantly
            const wheelBox = document.getElementById('wheelBox');
            wheelBox.style.transition = 'none';
            wheelBox.style.transform = `rotate(${currentAngle}deg)`;

            // 1. Request Action ID from the Server for pre-spin (security check)
            requestActionId('preSpin')
                .then(preSpinActionId => {
                    if (!preSpinActionId) return;
                    
                    // 2. Request pre-spin registration (Server checks for banned user and consumes the action ID)
                    return fetchApi({ type: 'preSpin', action_id: preSpinActionId });
                })
                .then(preSpinReqResult => {
                    if (!preSpinReqResult || !preSpinReqResult.ok) {
                        loadUserData();
                        return;
                    }
                    
                    // 3. Request Action ID from the Server for the spin result (prize confirmation)
                    return requestActionId('spinResult');
                })
                .then(spinResultActionId => {
                    if (!spinResultActionId) {
                         // English translation of the Arabic alert message
                        showCustomAlert('Security Error!', 'Failed to get confirmation token. Please try again.', 'error');
                        loadUserData();
                        return;
                    }
                    
                    // 4. Call Ad SDK (libtl.com)
                    show_10245709()
                        .then(async () => {
                            spinning = true;
                            spinBtn.disabled = true;
                            spinResult.textContent = 'Spinning...';

                            // 5. Request spin result and prize addition (Server runs limits, Rate Limit, and validates Action ID)
                            const spinResultRes = await fetchApi({
                                type: 'spinResult',
                                action_id: spinResultActionId // ‚¨ÖÔ∏è Send Action ID
                            });

                            if (spinResultRes.ok) {
                                playSFX('success');
                                const prizeIndex = spinResultRes.data.prize_index;
                                const actualReward = spinResultRes.data.actual_reward;
                                
                                // 6. Start wheel animation
                                rotateWheel(prizeIndex); 
                                
                                // 7. Update UI state immediately with trusted server values
                                updateState({
                                    balance: spinResultRes.data.new_balance,
                                    spins_today: spinResultRes.data.new_spins_count
                                });

                                spinResult.textContent = `Congrats! You won ${actualReward} SHIB!`;
                                
                            } else {
                                // If backend fails, reload and revert state
                                spinning = false;
                                spinBtn.disabled = false;
                                spinResult.textContent = 'Spin failed. Try again.';
                                loadUserData(); 
                            }
                        })
                        .catch((e) => {
                            // Ad error/cancellation handling
                             // English translation of the Arabic alert message
                            if (typeof e === 'string' && e.includes('canceled')) {
                                showCustomAlert('Ad Cancelled/Failed!', 'Spin attempt was not counted.', 'warning');
                            } else {
                                showCustomAlert('Ad Load Failed!', 'Ad failed to load. Spin attempt was not counted.', 'error');
                            }
                            spinning = false;
                            spinBtn.disabled = false;
                            spinResult.textContent = 'Spin failed. Try again.';
                            loadUserData();
                        });
                })
                .catch(error => {
                    console.error('Spin flow failed:', error);
                    // Error message already displayed by fetchApi or requestActionId
                    spinning = false;
                    spinBtn.disabled = false;
                    spinResult.textContent = 'Spin failed. Try again.';
                    loadUserData();
                });
        }


        /* ===== Withdraw Screen (No change) ===== */
        function displayWithdrawals() {
            const body = document.getElementById('withdrawalHistoryBody');
            const noHistory = document.getElementById('noHistory');
            body.innerHTML = ''; 

            if (appState.withdrawal_history.length === 0) {
                noHistory.style.display = 'block';
                return;
            }

            noHistory.style.display = 'none';

            appState.withdrawal_history.forEach(item => {
                const row = body.insertRow();
                row.insertCell().textContent = item.amount.toLocaleString('en-US', { maximumFractionDigits: 8 });
                const statusCell = row.insertCell();
                statusCell.textContent = item.status;
                statusCell.className = `status-${item.status}`;
                row.insertCell().textContent = item.date;
            });
        }
        
        async function requestWithdrawal() {
            if (isBanned) {
                showCustomAlert('Access Denied!', 'This account has been banned.', 'error');
                return;
            }
            const binanceId = document.getElementById('binanceIdInput').value.trim();
            const amount = parseFloat(document.getElementById('amountInput').value);
            
            if (!binanceId || isNaN(amount) || amount <= 0) {
                 // English translation of the Arabic alert message
                showCustomAlert('Input Error!', 'Please enter a valid Binance Pay ID and amount.', 'error');
                return;
            }

            const MIN_WITHDRAW_AMOUNT = 1000;
            if (amount < MIN_WITHDRAW_AMOUNT) {
                 // English translation of the Arabic alert message
                showCustomAlert('Minimum Amount!', `Minimum withdrawal is ${MIN_WITHDRAW_AMOUNT.toLocaleString()} SHIB.`, 'error');
                return;
            }

            if (amount > appState.balance) {
                 // English translation of the Arabic alert message
                showCustomAlert('Insufficient Balance!', `You only have ${appState.balance.toLocaleString()} SHIB.`, 'error');
                return;
            }
            
            // 1. Request Action ID from the Server ‚¨ÖÔ∏è ÿ™ŸÖ ÿßŸÑÿ™ŸÅÿπŸäŸÑ ÿπŸÑŸâ Withdraw
            const actionId = await requestActionId('withdraw');
            if (!actionId) return;

            // 2. Send withdrawal request via API
            const result = await fetchApi({
                type: 'withdraw',
                binanceId: binanceId,
                amount: amount,
                action_id: actionId // ‚¨ÖÔ∏è ÿ•ÿ±ÿ≥ÿßŸÑ Action ID
            });

            if (result.ok) {
                // 3. Update balance with trusted server value
                updateState({ balance: result.data.new_balance });
                
                // 4. Reload withdrawal history with new data
                await loadUserData(); 
                displayWithdrawals(); 
                
                // English translation of the Arabic alert message
                showCustomAlert('Request Sent!', `Details:\nBinance ID: ${binanceId}\nAmount: ${amount.toLocaleString()} SHIB\n\nThe transfer will be processed within 24 hours.`, 'success');
            }
        }
        
        /* ===== Invite Screen (No change) ===== */
        function displayReferrals() {
             document.getElementById('referralsCount').textContent = appState.referrals_count.toLocaleString();
        }

        function copyReferralLink() {
            const linkInput = document.getElementById('referralLinkInput');
            linkInput.select();
            linkInput.setSelectionRange(0, 99999); // For mobile devices

            navigator.clipboard.writeText(linkInput.value).then(() => {
                // English translation of the Arabic alert message
                showCustomAlert('Link Copied! üîó', 'Your referral link has been copied to the clipboard.', 'success');
            }).catch(err => {
                console.error('Failed to copy text: ', err);
                // English translation of the Arabic alert message
                showCustomAlert('Copy Failed!', 'Failed to copy the link. Please try again.', 'error');
            });
        }
        
        /* ===== Audio/Initialization (No change) ===== */
        function playBGAudio() {
            const audio = document.getElementById('backgroundAudio');
            if (audio) {
                audio.volume = 0.3; // Lower volume
                audio.play().catch(e => console.log('Background audio playback failed:', e));
            }
        }
        
        drawWheel(); // Draw the initial wheel
        loadAll(); // Start the app flow

        // Final event listener to ensure background audio starts on the first user interaction
        document.addEventListener('click', function handler() {
            playBGAudio();
            document.removeEventListener('click', handler); // Remove after first successful click
        });
        
        /* =============================================================== */
        /* =================== ORIGINAL SCRIPT END ======================= */
        /* =============================================================== */
    </script>
</body>
</html>